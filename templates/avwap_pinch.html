{% extends "base.html" %}

{% block title %}The AVWAP Pinch - Trading-Strategie{% endblock %}

{% block content %}
<style>
    /* AVWAP Pinch - Didis Design-System */
    
    /* Gamification Dashboard - Premium Gold Design */
    .gamification-dashboard {
        position: sticky;
        top: 0;
        z-index: 100;
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--gold-dark) 100%);
        color: white;
        padding: 20px;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        margin: -20px -20px 2rem -20px;
    }
    
    .gamification-dashboard h2 {
        color: var(--gold-light);
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
    }
    
    .gamification-dashboard p {
        color: rgba(255, 255, 255, 0.9);
        margin: 5px 0;
        font-style: italic;
    }
    
    /* Section Titles - Gold Accent */
    .section-title {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-dark);
        margin: 2rem 0 1rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 3px solid var(--gold-classic);
        position: relative;
    }
    
    .section-title::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 60px;
        height: 3px;
        background: var(--gold-light);
    }
    
    /* Concept Highlight - Premium Design */
    .concept-highlight {
        background: linear-gradient(135deg, var(--bg-card) 0%, #f8f9fa 100%);
        border-left: 4px solid var(--gold-classic);
        padding: 2rem;
        margin: 2rem 0;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
    }
    
    .concept-highlight::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--gold-dark), var(--gold-classic), var(--gold-light));
        border-radius: 12px 12px 0 0;
    }
    
    .concept-highlight h4 {
        color: var(--primary-dark);
        margin-bottom: 1rem;
        font-size: 1.3rem;
    }
    
    /* Success Box - Grün mit Gold-Akzenten */
    .success-box {
        background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
        border: 2px solid var(--success);
        padding: 2rem;
        margin: 2rem 0;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(5, 150, 105, 0.1);
        position: relative;
    }
    
    .success-box h4 {
        color: var(--success);
        margin-bottom: 1rem;
        font-size: 1.3rem;
    }
    
    /* Warning Box - Orange mit Gold-Harmonie */
    .warning-box {
        background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
        border: 2px solid var(--warning);
        padding: 2rem;
        margin: 2rem 0;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(214, 158, 46, 0.1);
        position: relative;
    }
    
    .warning-box h4 {
        color: var(--warning);
        margin-bottom: 1rem;
        font-size: 1.3rem;
    }
    
    /* Trading Rule - Premium Gold Design */
    .trading-rule {
        background: linear-gradient(135deg, var(--gold-light) 0%, #f9f7e8 100%);
        border: 2px solid var(--gold-classic);
        padding: 2rem;
        margin: 2rem 0;
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(218, 165, 32, 0.15);
    }
    
    .trading-rule::before {
        content: "📈";
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 2rem;
        opacity: 0.3;
    }
    
    .trading-rule h4 {
        color: var(--primary-dark);
        margin-bottom: 1rem;
        font-size: 1.3rem;
        font-weight: 700;
    }
    
    /* Chart Container - Premium Design */
    .chart-container {
        background: var(--bg-card);
        padding: 2rem;
        margin: 2rem 0;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        text-align: center;
        border: 1px solid #e0e0e0;
    }
    
    .chart-image {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        margin: 1rem 0;
        transition: transform 0.3s ease;
    }
    
    .chart-image:hover {
        transform: scale(1.02);
    }
    
    .chart-caption {
        color: #666;
        font-size: 0.9rem;
        font-style: italic;
        margin-top: 1rem;
        line-height: 1.4;
    }
    
    /* Next Button - Premium Gold Design */
    .next-button {
        background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold-classic) 100%);
        color: white;
        padding: 1.2rem 2.5rem;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        margin: 2rem auto;
        display: block;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(218, 165, 32, 0.3);
        text-transform: none;
    }
    
    .next-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(218, 165, 32, 0.4);
        background: linear-gradient(135deg, var(--gold-classic) 0%, var(--gold-light) 100%);
        color: var(--primary-dark);
    }
    
    /* Key Takeaways - Premium Design */
    .key-takeaway {
        background: var(--bg-card);
        padding: 1.5rem;
        margin: 1rem 0;
        border-left: 4px solid var(--gold-classic);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease;
    }
    
    .key-takeaway:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .key-takeaway p {
        margin: 0;
        font-size: 1rem;
        line-height: 1.6;
        color: var(--primary-dark);
    }
    
    /* Quiz Section - Premium Design */
    .quiz-section {
        background: linear-gradient(135deg, var(--bg-card) 0%, #f8f9fa 100%);
        border: 2px solid var(--gold-classic);
        border-radius: 12px;
        padding: 2rem;
        margin: 2rem 0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .quiz-section h3 {
        color: var(--primary-dark);
        margin-bottom: 1.5rem;
        font-size: 1.4rem;
    }
    
    .quiz-question {
        margin: 1.5rem 0;
    }
    
    .quiz-question p {
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }
    
    .quiz-option {
        margin: 0.8rem 0;
        padding: 1rem 1.5rem;
        background: var(--bg-card);
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        line-height: 1.4;
    }
    
    .quiz-option:hover {
        background: #f8f9fa;
        border-color: var(--gold-classic);
        transform: translateX(5px);
    }
    
    .quiz-option.selected {
        background: linear-gradient(135deg, var(--gold-light) 0%, #f9f7e8 100%);
        border-color: var(--gold-classic);
        font-weight: 600;
        color: var(--primary-dark);
    }
    
    /* Quiz Results */
    .quiz-result {
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .quiz-result.success {
        background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
        color: var(--success);
        border: 2px solid var(--success);
    }
    
    .quiz-result.warning {
        background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
        color: var(--warning);
        border: 2px solid var(--warning);
    }
    
    /* Progress Bar - Gold Design */
    .progress-bar {
        background: rgba(255, 255, 255, 0.3);
        height: 12px;
        border-radius: 6px;
        margin-top: 10px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .progress-fill {
        background: linear-gradient(90deg, var(--gold-classic), var(--gold-light));
        height: 100%;
        border-radius: 6px;
        transition: width 0.8s ease;
        box-shadow: 0 2px 4px rgba(218, 165, 32, 0.3);
    }
    
    /* Step Content Animation */
    .step-content {
        display: none;
    }
    
    .step-content.active {
        display: block;
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from { 
            opacity: 0; 
            transform: translateY(30px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }
    
    /* Completion Celebration - Premium Design */
    .completion-celebration {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--gold-dark) 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 15px;
        margin: 3rem 0;
        text-align: center;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .completion-celebration::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .completion-celebration h2 {
        color: var(--gold-light);
        margin: 0 0 1rem 0;
        font-size: 2.2rem;
    }
    
    .completion-celebration h3 {
        color: white;
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
    }
    
    /* Debug Controls - Minimal Design */
    .debug-controls {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(26, 26, 26, 0.95);
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--gold-dark);
    }
    
    .debug-controls.active {
        display: block;
    }
    
    .debug-controls button {
        background: var(--gold-dark);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    
    .debug-controls select {
        background: var(--primary-medium);
        color: white;
        border: 1px solid var(--gold-dark);
        padding: 5px;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    /* Blockquotes - Premium Style */
    blockquote {
        background: linear-gradient(135deg, #f8f9fa 0%, var(--bg-card) 100%);
        border-left: 4px solid var(--gold-classic);
        padding: 1.5rem 2rem;
        margin: 2rem 0;
        border-radius: 0 8px 8px 0;
        font-style: italic;
        color: var(--primary-dark);
        font-size: 1.1rem;
        line-height: 1.6;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    /* Lists - Enhanced Style */
    ol, ul {
        padding-left: 2rem;
        line-height: 1.8;
    }
    
    li {
        margin: 0.5rem 0;
        color: var(--primary-dark);
    }
    
    li strong {
        color: var(--gold-dark);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .gamification-dashboard {
            margin: -20px -10px 2rem -10px;
            padding: 15px;
        }
        
        .gamification-dashboard > div {
            flex-direction: column;
            text-align: center;
        }
        
        .section-title {
            font-size: 1.6rem;
        }
        
        .concept-highlight,
        .success-box,
        .warning-box,
        .trading-rule,
        .quiz-section {
            padding: 1.5rem;
        }
        
        .next-button {
            padding: 1rem 2rem;
            font-size: 1rem;
        }
        
        .chart-container {
            padding: 1rem;
        }
    }
</style>

<!-- Gamification Dashboard -->
<div class="gamification-dashboard">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
        <div>
            <h2 style="color: white; margin: 0;">📊 Chapter 5: The AVWAP Pinch</h2>
            <p style="margin: 5px 0; opacity: 0.9;">"Energy and persistence conquer all things." - Benjamin Franklin</p>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 24px; font-weight: bold;">
                Fortschritt: <span id="progress-text">0</span>/6 Schritte
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Debug Controls -->
<div class="debug-controls" id="debug-controls">
    <button onclick="toggleDebug()" style="margin-bottom: 10px;">🔧 Debug-Modus</button>
    <div>
        <label>Springe zu Schritt:</label>
        <select id="debug-step-select" onchange="jumpToStep(this.value)">
            <option value="0">0 - Start</option>
            <option value="1">1 - Was ist ein Pinch?</option>
            <option value="2">2 - Wie entsteht ein Pinch?</option>
            <option value="3">3 - Wann einsteigen?</option>
            <option value="4">4 - Risk Management</option>
            <option value="5">5 - Praxisbeispiele</option>
            <option value="6">6 - Key Takeaways</option>
        </select>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <!-- Einleitung (immer sichtbar) -->
    <div class="section-title">🎯 Lernziele dieses Kapitels</div>
    
    <div class="concept-highlight">
        <h4>Was du lernen wirst:</h4>
        <ul style="font-size: 16px; line-height: 1.8;">
            <li>✅ Einen Pinch erkennen, während er sich bildet</li>
            <li>✅ Wann du in einen Pinch einsteigen solltest</li>
            <li>✅ Wer die Kontrolle über einen Pinch hat</li>
            <li>✅ Warum ein Pinch kein Grund ist, eine Aktie zu kaufen oder zu shorten</li>
            <li>✅ Wie du das Risiko managst, wenn eine Aktie aus einem engen Pinch ausbricht</li>
        </ul>
    </div>
    
    <!-- Schritt 0: Start -->
    <div id="step-0" class="step-content active">
        <button class="next-button" onclick="nextStep()">✅ Verstanden - Weiter zu: Was ist ein AVWAP Pinch?</button>
    </div>
    
    <!-- Schritt 1: Was ist ein AVWAP Pinch? -->
    <div id="step-1" class="step-content">
        <div class="section-title">📌 Was ist ein AVWAP Pinch?</div>
        
        <div class="concept-highlight">
            <h4>🎯 Das Grundkonzept</h4>
            <p style="font-size: 16px; line-height: 1.6;">
            Ein <strong>AVWAP Pinch</strong> ist eine <strong>Kompression der Preisspanne</strong> zwischen zwei AVWAPs. 
            Es ist ein Kampf zwischen Käufern und Verkäufern, bei dem die Energie komprimiert wird - 
            wie eine Feder, die zusammengedrückt wird.
            </p>
        </div>
        
        <p><strong>🔍 Die Anatomie eines Pinch:</strong></p>
        
        <ol>
            <li><strong>Längerfristiger Trend AVWAP</strong> - Repräsentiert den dominanten Trend</li>
            <li><strong>Kurzfristiger Gegentrend AVWAP</strong> - Zeigt die aktuelle Korrektur</li>
            <li><strong>Konvergierende Linien</strong> - Die beiden AVWAPs nähern sich an</li>
            <li><strong>Energie-Kompression</strong> - Volumen und Range kontrahieren</li>
            <li><strong>Ausbruch</strong> - Die komprimierte Energie wird freigesetzt</li>
        </ol>
        
        <p><strong>💡 Kernprinzip:</strong></p>
        <blockquote style="font-style: italic; color: #059669; font-size: 16px; margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #059669;">
        "Aktien, die aus einem Pinch ausbrechen, können einige der <strong>risikoärmsten, wahrscheinlichsten</strong> 
        Trend-Fortsetzungs-Trades bieten."
        </blockquote>
        
        <!-- Chart -->
        <div class="chart-container">
            <img src="{{ url_for('static', filename='../templates/Screenshots/Pinch_UTHR_2025-09-10_18-09-25.jpg') }}" 
                 alt="AVWAP Pinch Grundkonzept - UTHR" 
                 class="chart-image">
            <p class="chart-caption">
                <strong>AVWAP Pinch Grundkonzept - UTHR</strong><br>
                Zeigt zwei konvergierende AVWAPs mit Preisbewegung dazwischen. Die Energie wird komprimiert wie eine zusammengedrückte Feder.
            </p>
        </div>
        
        <!-- Quiz für Schritt 1 -->
        <div class="quiz-section">
            <h3>🧠 Quiz: AVWAP Pinch verstehen</h3>
            <div class="quiz-question">
                <p><strong>Was ist ein AVWAP Pinch?</strong></p>
                <div class="quiz-option" data-quiz="quiz1" data-answer="correct" onclick="selectQuizOption(this)">Eine Kompression der Preisspanne zwischen zwei AVWAPs</div>
                <div class="quiz-option" data-quiz="quiz1" data-answer="wrong" onclick="selectQuizOption(this)">Ein starker Ausbruch nach oben</div>
                <div class="quiz-option" data-quiz="quiz1" data-answer="wrong" onclick="selectQuizOption(this)">Eine horizontale Seitwärtsbewegung</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Ein Pinch zeigt:</strong></p>
                <div class="quiz-option" data-quiz="quiz1" data-answer="correct" onclick="selectQuizOption(this)">Einen Kampf zwischen Käufern und Verkäufern</div>
                <div class="quiz-option" data-quiz="quiz1" data-answer="wrong" onclick="selectQuizOption(this)">Eine klare Trendrichtung</div>
                <div class="quiz-option" data-quiz="quiz1" data-answer="wrong" onclick="selectQuizOption(this)">Ein garantiertes Kaufsignal</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Die Energie in einem Pinch ist wie:</strong></p>
                <div class="quiz-option" data-quiz="quiz1" data-answer="correct" onclick="selectQuizOption(this)">Eine zusammengedrückte Feder</div>
                <div class="quiz-option" data-quiz="quiz1" data-answer="wrong" onclick="selectQuizOption(this)">Ein ruhiger Bergsee</div>
                <div class="quiz-option" data-quiz="quiz1" data-answer="wrong" onclick="selectQuizOption(this)">Ein gleichmäßiger Wasserfall</div>
            </div>
            
            <button class="btn" onclick="checkQuiz('quiz1', 3)">Antworten prüfen</button>
            <div id="quiz1-result" class="quiz-result" style="display: none;"></div>
        </div>
        
        <button class="next-button" onclick="nextStep()">✅ Verstanden - Weiter zu: Wie entsteht ein Pinch?</button>
    </div>
    
    <!-- Schritt 2: Wie entsteht ein Pinch? -->
    <div id="step-2" class="step-content">
        <div class="section-title">🔄 Wie entsteht ein Pinch?</div>
        
        <div class="warning-box">
            <h4>⚡ Die Entstehung eines Pinch</h4>
        </div>
        
        <p><strong>📊 Der Prozess Schritt für Schritt:</strong></p>
        
        <p><strong>1️⃣ Trends sind mehrdimensional</strong></p>
        <ul>
            <li>Es gibt Trends innerhalb von Trends</li>
            <li>Ein längerfristiger Aufwärtstrend kann kurzfristige Pullbacks haben</li>
            <li>Diese Counter-Trends bilden neue AVWAPs</li>
        </ul>
        
        <p><strong>2️⃣ Die zwei AVWAP-Kräfte:</strong></p>
        <ul>
            <li><strong>Original AVWAP:</strong> Support/Resistance vom längerfristigen, kraftvolleren Trend</li>
            <li><strong>Neuer AVWAP:</strong> Enthält Price Action vom Counter-Trend (Korrektur)</li>
        </ul>
        
        <p><strong>3️⃣ Die Konvergenz:</strong></p>
        <ul>
            <li>Während sich die Range verengt, zeigt sich eine <strong>Energiekontraktion</strong></li>
            <li>Die Aktie nähert sich einem <strong>Gleichgewichtszustand</strong></li>
            <li>Trading-Volumen und Preisspanne kontrahieren gleichzeitig</li>
        </ul>
        
        <p><strong>4️⃣ Die Psychologie:</strong></p>
        
        <div class="trading-rule">
            <h4>🧠 Marktpsychologie im Pinch</h4>
            <p style="color: #059669; font-size: 16px; line-height: 1.6;">
            <strong>"Es gibt keinen Vorteil, in der Aktie involviert zu sein, während dieser Kampf andauert 
            und die Aktie 'im Pinch' ist."</strong>
            </p>
            <p style="font-size: 16px; line-height: 1.6;">
            Stattdessen wollen wir die Aktie beobachten für die <strong>Wiederkehr des primären Trends</strong>, 
            damit wir teilnehmen können, wenn der kurzfristige Trend sich mit dem längeren, 
            kraftvolleren Trend ausrichtet.
            </p>
        </div>
        
        <!-- Chart -->
        <div class="chart-container">
            <img src="{{ url_for('static', filename='../templates/Screenshots/Pinch_SNPS_2025-09-11_09-45-39.jpg') }}" 
                 alt="Pinch-Entstehung - SNPS" 
                 class="chart-image">
            <p class="chart-caption">
                <strong>Pinch-Entstehung - SNPS</strong><br>
                Synopsys zeigt die schrittweise Konvergenz von zwei AVWAPs mit abnehmendem Volumen und Energiekontraktion.
            </p>
        </div>
        
        <!-- Quiz für Schritt 2 -->
        <div class="quiz-section">
            <h3>🧠 Quiz: Pinch-Entstehung</h3>
            <div class="quiz-question">
                <p><strong>Während eines Pinch solltest du:</strong></p>
                <div class="quiz-option" data-quiz="quiz2" data-answer="wrong" onclick="selectQuizOption(this)">Sofort kaufen</div>
                <div class="quiz-option" data-quiz="quiz2" data-answer="correct" onclick="selectQuizOption(this)">Warten und beobachten</div>
                <div class="quiz-option" data-quiz="quiz2" data-answer="wrong" onclick="selectQuizOption(this)">Immer shorten</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Ein Pinch zeigt:</strong></p>
                <div class="quiz-option" data-quiz="quiz2" data-answer="wrong" onclick="selectQuizOption(this)">Klare Richtung</div>
                <div class="quiz-option" data-quiz="quiz2" data-answer="correct" onclick="selectQuizOption(this)">Gleichgewichtszustand</div>
                <div class="quiz-option" data-quiz="quiz2" data-answer="wrong" onclick="selectQuizOption(this)">Starken Trend</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Volumen während eines Pinch:</strong></p>
                <div class="quiz-option" data-quiz="quiz2" data-answer="wrong" onclick="selectQuizOption(this)">Steigt stark</div>
                <div class="quiz-option" data-quiz="quiz2" data-answer="correct" onclick="selectQuizOption(this)">Kontrahiert oft</div>
                <div class="quiz-option" data-quiz="quiz2" data-answer="wrong" onclick="selectQuizOption(this)">Bleibt konstant</div>
            </div>
            
            <button class="btn" onclick="checkQuiz('quiz2', 3)">Antworten prüfen</button>
            <div id="quiz2-result" class="quiz-result" style="display: none;"></div>
        </div>
        
        <button class="next-button" onclick="nextStep()">✅ Verstanden - Weiter zu: Wann einsteigen?</button>
    </div>
    
    <!-- Schritt 3: Wann einsteigen? -->
    <div id="step-3" class="step-content">
        <div class="section-title">⏰ Wann einsteigen?</div>
        
        <div class="success-box">
            <h4>🎯 Der perfekte Einstiegszeitpunkt</h4>
        </div>
        
        <p><strong>📈 Die goldene Regel:</strong></p>
        <blockquote style="font-style: italic; color: #059669; font-size: 16px; margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #059669;">
        <strong>"Der ideale Zeitpunkt, eine Aktie zu kaufen, ist wenn sie aus einer engen Range ausbricht."</strong>
        </blockquote>
        
        <p><strong>Warum das so wichtig ist:</strong></p>
        
        <p><strong>1️⃣ Zwei entscheidende Vorteile:</strong></p>
        <ul>
            <li><strong>Maximales Gewinnpotenzial:</strong> Du steigst ein, genau wenn der Trend beginnt</li>
            <li><strong>Minimales Risiko:</strong> Wenn der Ausbruch scheitert, kannst du den Stop eng setzen</li>
        </ul>
        
        <p><strong>2️⃣ Der Ausbruchsprozess:</strong></p>
        <ol>
            <li><strong>Beobachte</strong> die Aktie im Pinch</li>
            <li><strong>Setze Alerts</strong> für den Ausbruch</li>
            <li><strong>Warte auf Bestätigung</strong> - Preis muss aus der Range ausbrechen</li>
            <li><strong>Kaufe</strong> beim bestätigten Ausbruch</li>
            <li><strong>Setze Stop</strong> knapp unter dem Ausbruchsniveau</li>
        </ol>
        
        <div class="warning-box">
            <h4>⚠️ Wichtige Warnung</h4>
            <p style="font-size: 16px; line-height: 1.6;">
            <strong>Ein AVWAP Pinch wird höchstwahrscheinlich in Richtung des primären Trends ausbrechen.</strong>
            Je enger der Pinch, desto wahrscheinlicher ist ein kraftvoller Ausbruch.
            </p>
            <p style="font-size: 16px; line-height: 1.6; color: #dc2626;">
            <strong>ABER:</strong> Nicht alle Pinches lösen sich in Richtung des primären Trends auf, 
            weshalb wir auf Preisbestätigung warten, bevor wir einsteigen.
            </p>
        </div>
        
        <!-- Chart -->
        <div class="chart-container">
            <img src="{{ url_for('static', filename='../templates/Screenshots/Pinch_SNPS_BO_2025-09-11_09-45-39.jpg') }}" 
                 alt="Pinch-Ausbruch mit Entry - SNPS Breakout" 
                 class="chart-image">
            <p class="chart-caption">
                <strong>Pinch-Ausbruch - SNPS Breakout</strong><br>
                Synopsys Ausbruch aus dem Pinch mit markiertem Einstiegspunkt und Stop-Loss. Perfektes Timing für maximales Gewinnpotenzial bei minimalem Risiko.
            </p>
        </div>
        
        <!-- Quiz für Schritt 3 -->
        <div class="quiz-section">
            <h3>🧠 Quiz: Trading-Timing</h3>
            <div class="quiz-question">
                <p><strong>Der beste Zeitpunkt zum Kaufen ist:</strong></p>
                <div class="quiz-option" data-quiz="quiz3" data-answer="wrong" onclick="selectQuizOption(this)">Im Pinch</div>
                <div class="quiz-option" data-quiz="quiz3" data-answer="correct" onclick="selectQuizOption(this)">Beim Ausbruch aus dem Pinch</div>
                <div class="quiz-option" data-quiz="quiz3" data-answer="wrong" onclick="selectQuizOption(this)">Nach dem Pinch</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Warum warten wir auf den Ausbruch?</strong></p>
                <div class="quiz-option" data-quiz="quiz3" data-answer="wrong" onclick="selectQuizOption(this)">Für Spannung</div>
                <div class="quiz-option" data-quiz="quiz3" data-answer="correct" onclick="selectQuizOption(this)">Für bestes Risiko/Gewinn-Verhältnis</div>
                <div class="quiz-option" data-quiz="quiz3" data-answer="wrong" onclick="selectQuizOption(this)">Aus Tradition</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Wo setzen wir den Stop-Loss?</strong></p>
                <div class="quiz-option" data-quiz="quiz3" data-answer="wrong" onclick="selectQuizOption(this)">Weit weg</div>
                <div class="quiz-option" data-quiz="quiz3" data-answer="correct" onclick="selectQuizOption(this)">Knapp unter dem Ausbruchsniveau</div>
                <div class="quiz-option" data-quiz="quiz3" data-answer="wrong" onclick="selectQuizOption(this)">Gar nicht</div>
            </div>
            
            <button class="btn" onclick="checkQuiz('quiz3', 3)">Antworten prüfen</button>
            <div id="quiz3-result" class="quiz-result" style="display: none;"></div>
        </div>
        
        <button class="next-button" onclick="nextStep()">✅ Verstanden - Weiter zu: Risk Management</button>
    </div>
    
    <!-- Schritt 4: Risk Management -->
    <div id="step-4" class="step-content">
        <div class="section-title">🛡️ Risk Management mit dem Pinch</div>
        
        <div class="trading-rule">
            <h4>📊 R-Multiple Strategie</h4>
            <p style="color: #059669; font-size: 16px; line-height: 1.6;">
            Wenn eine Aktie aus einem engen Pinch ausbricht, können wir <strong>enge Stops halten</strong> 
            und <strong>mehr Anteile</strong> mit dem R-Multiple at Risk handeln.
            </p>
        </div>
        
        <p><strong>🎯 Stop-Loss Regeln:</strong></p>
        
        <p><strong>Für Long-Positionen:</strong></p>
        <ul>
            <li>Stop <strong>unter</strong> dem jüngsten und relevantesten <strong>Higher-Low</strong></li>
            <li>Je enger der Stop, desto größer kann die Position sein (bei konstantem R)</li>
        </ul>
        
        <p><strong>Für Short-Positionen:</strong></p>
        <ul>
            <li>Stop <strong>über</strong> dem jüngsten <strong>Lower-High</strong></li>
            <li>Gleiche Logik: Enger Stop = Größere Position möglich</li>
        </ul>
        
        <p><strong>📈 Die Trend-Definition:</strong></p>
        <blockquote style="font-style: italic; color: #059669; font-size: 16px; margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #059669;">
        "Die simple Definition eines Trends sagt uns, wo wir Gelegenheiten kaufen sollten: 
        in <strong>Aufwärtstrends</strong> und short in <strong>Abwärtstrends</strong>."
        </blockquote>
        
        <p><strong>⚠️ Häufiger Fehler:</strong></p>
        <p>Viele Trader kämpfen gegen diesen gesunden Menschenverstand:</p>
        <ul>
            <li>Sie versuchen, Aktien in Abwärtstrends zu kaufen (irrational verankert an frühere Preise)</li>
            <li>Sie sehen es als "Schnäppchen" während die Preise fallen</li>
            <li>Sie versuchen, Aktien zu shorten, die "zu viel" gestiegen sind</li>
        </ul>
        
        <p><strong>✅ Die richtige Einstellung:</strong></p>
        <blockquote style="font-style: italic; color: #059669; font-size: 16px; margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #059669;">
        "Umarme die höhere Wahrscheinlichkeit (und niedrigeren Stress) Gewinne, die kommen, 
        wenn man dem Trend folgt."
        </blockquote>
        
        <div class="success-box">
            <h4>💡 Stop-Management während des Trades</h4>
        </div>
        
        <p><strong>Nach dem Einstieg:</strong></p>
        
        <ol>
            <li><strong>Initial Stop:</strong> Knapp unter dem Ausbruchsniveau</li>
            <li><strong>Bei neuem High:</strong> Stop auf vorheriges Higher-Low anheben</li>
            <li><strong>Teilverkauf:</strong> Bei starken Bewegungen Teil der Position verkaufen</li>
            <li><strong>Rest-Position:</strong> Stop auf Break-Even oder besser anheben</li>
            <li><strong>Trend folgen:</strong> Stop nachziehen mit jedem neuen Higher-Low</li>
        </ol>
        
        <p><strong>📊 Reales Trading-Beispiel (NBIS):</strong></p>
        <ul>
            <li><strong>Einstieg:</strong> $90.00 nach Pinch-Ausbruch</li>
            <li><strong>Alternative:</strong> Zweiter Einstieg bei "Handoff" Pull Back $90.40</li>
            <li><strong>Initial Stop:</strong> $86.11 (Risiko: $3.89 pro Aktie)</li>
            <li><strong>Teilgewinn:</strong> Bei HOD $98.00 → Hälfte verkaufen (+8.89% Gewinn)</li>
            <li><strong>Stop-Anpassung:</strong> Stop auf $90.00 anheben (Break-Even für Rest-Position)</li>
            <li><strong>Resultat:</strong> Risikofreier Trade mit bereits realisiertem Teilgewinn</li>
        </ul>
        
        <h3>📊 Live Chart-Beispiel:</h3>
        
        <!-- Chart -->
        <div class="chart-container">
            <img src="{{ url_for('static', filename='../templates/Screenshots/Pinch_NBIS_SL_11-09-2025_10-20-42.jpg') }}" 
                 alt="Stop-Management Beispiel - NBIS" 
                 class="chart-image">
            <p class="chart-caption">
                <strong>Stop-Management Beispiel - NBIS</strong><br>
                Neurocrine Biosciences - Realer Trade mit Einstieg bei $90, Initial Stop bei $86.11 und Teilgewinn bei HOD $98. Risikofreier Trade durch professionelles Stop-Management.
            </p>
        </div>
        
        <!-- Quiz für Schritt 4 -->
        <div class="quiz-section">
            <h3>🧠 Quiz: Risk Management</h3>
            <div class="quiz-question">
                <p><strong>Je enger der Pinch, desto:</strong></p>
                <div class="quiz-option" data-quiz="quiz4" data-answer="wrong" onclick="selectQuizOption(this)">Größer das Risiko</div>
                <div class="quiz-option" data-quiz="quiz4" data-answer="correct" onclick="selectQuizOption(this)">Kleiner kann der Stop sein</div>
                <div class="quiz-option" data-quiz="quiz4" data-answer="wrong" onclick="selectQuizOption(this)">Unwichtiger der Trade</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Bei einem neuen High solltest du:</strong></p>
                <div class="quiz-option" data-quiz="quiz4" data-answer="wrong" onclick="selectQuizOption(this)">Sofort verkaufen</div>
                <div class="quiz-option" data-quiz="quiz4" data-answer="correct" onclick="selectQuizOption(this)">Stop nachziehen</div>
                <div class="quiz-option" data-quiz="quiz4" data-answer="wrong" onclick="selectQuizOption(this)">Stop belassen</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Die beste Strategie ist:</strong></p>
                <div class="quiz-option" data-quiz="quiz4" data-answer="wrong" onclick="selectQuizOption(this)">Gegen den Trend handeln</div>
                <div class="quiz-option" data-quiz="quiz4" data-answer="correct" onclick="selectQuizOption(this)">Dem Trend folgen</div>
                <div class="quiz-option" data-quiz="quiz4" data-answer="wrong" onclick="selectQuizOption(this)">Trend ignorieren</div>
            </div>
            
            <button class="btn" onclick="checkQuiz('quiz4', 3)">Antworten prüfen</button>
            <div id="quiz4-result" class="quiz-result" style="display: none;"></div>
        </div>
        
        <button class="next-button" onclick="nextStep()">✅ Verstanden - Weiter zu: Praxisbeispiele</button>
    </div>
    
    <!-- Schritt 5: Praxisbeispiele -->
    <div id="step-5" class="step-content">
        <div class="section-title">📊 Praxisbeispiele</div>
        
        <div class="concept-highlight">
            <h4>Chart 5.2: 30-Minuten Chart mit Pinch</h4>
        </div>
        
        <!-- Chart -->
        <div class="chart-container">
            <img src="{{ url_for('static', filename='../templates/Screenshots/Pinch_SNPS_BO_2025-09-11_09-45-39.jpg') }}" 
                 alt="Chart 5.2 - 30-Minuten Pinch" 
                 class="chart-image">
            <p class="chart-caption">
                <strong>Chart 5.2 - 30-Minuten Pinch Analyse</strong><br>
                Detaillierte Schritt-für-Schritt Analyse eines AVWAP Pinch mit nummerierten Annotationen (1-10) für optimales Verständnis der Trading-Sequenz.
            </p>
        </div>
        
        <p><strong>📖 Schritt-für-Schritt Analyse:</strong></p>
        
        <ol>
            <li><strong>Initial AVWAP (1):</strong> Beginn des primären Trends</li>
            <li><strong>VWAP from High (2):</strong> Pullback beginnt, neuer AVWAP startet</li>
            <li><strong>Buy Point (3):</strong> Erste Kaufgelegenheit identifiziert</li>
            <li><strong>Protective Stop (4):</strong> Initial Stop unter Support</li>
            <li><strong>Higher High (5):</strong> Bestätigung des Aufwärtstrends</li>
            <li><strong>Initial Stop (6):</strong> Stop-Loss Position</li>
            <li><strong>New High (7):</strong> Stop auf (8) anheben</li>
            <li><strong>New Stop 1 (8):</strong> Angehobener Stop nach Higher-Low</li>
            <li><strong>Another New High (9):</strong> Weiterer Fortschritt</li>
            <li><strong>New Stop 2 (10):</strong> Final angehobener Stop</li>
        </ol>
        
        <p><strong>💡 Wichtige Beobachtung:</strong></p>
        <blockquote style="font-style: italic; color: #059669; font-size: 16px; margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #059669;">
        "Beachte, wie die Aktie nicht sofort höheres Momentum fand. Wenn die Aktie den Initial Stop 
        nicht verletzt (in diesem Fall bei 6), gib der Aktie die Gelegenheit zu arbeiten."
        </blockquote>
        
        <p><strong>🎯 Trading-Tipp:</strong></p>
        <blockquote style="font-style: italic; color: #059669; font-size: 16px; margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #059669;">
        "Ein starker Move wie dieser ist oft eine exzellente Gelegenheit, einen Teil der Aktie zu verkaufen 
        und dann den Stop auf dem Rest auf das Higher-Low anzuheben."
        </blockquote>
        
        <!-- Quiz für Schritt 5 -->
        <div class="quiz-section">
            <h3>🧠 Quiz: Praxisanwendung</h3>
            <div class="quiz-question">
                <p><strong>Was machst du bei einem starken Anstieg nach Pinch-Ausbruch?</strong></p>
                <div class="quiz-option" data-quiz="quiz5" data-answer="wrong" onclick="selectQuizOption(this)">Alles verkaufen</div>
                <div class="quiz-option" data-quiz="quiz5" data-answer="correct" onclick="selectQuizOption(this)">Teilverkauf und Stop anheben</div>
                <div class="quiz-option" data-quiz="quiz5" data-answer="wrong" onclick="selectQuizOption(this)">Nichts</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Wenn die Aktie den Initial Stop nicht verletzt:</strong></p>
                <div class="quiz-option" data-quiz="quiz5" data-answer="wrong" onclick="selectQuizOption(this)">Sofort verkaufen</div>
                <div class="quiz-option" data-quiz="quiz5" data-answer="correct" onclick="selectQuizOption(this)">Der Aktie Zeit geben</div>
                <div class="quiz-option" data-quiz="quiz5" data-answer="wrong" onclick="selectQuizOption(this)">Stop entfernen</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Bei jedem neuen Higher-High:</strong></p>
                <div class="quiz-option" data-quiz="quiz5" data-answer="wrong" onclick="selectQuizOption(this)">Stop belassen</div>
                <div class="quiz-option" data-quiz="quiz5" data-answer="correct" onclick="selectQuizOption(this)">Stop auf vorheriges Higher-Low anheben</div>
                <div class="quiz-option" data-quiz="quiz5" data-answer="wrong" onclick="selectQuizOption(this)">Verkaufen</div>
            </div>
            
            <button class="btn" onclick="checkQuiz('quiz5', 3)">Antworten prüfen</button>
            <div id="quiz5-result" class="quiz-result" style="display: none;"></div>
        </div>
        
        <button class="next-button" onclick="nextStep()">✅ Verstanden - Weiter zu: Key Takeaways</button>
    </div>
    
    <!-- Schritt 6: Key Takeaways -->
    <div id="step-6" class="step-content">
        <div class="section-title">🎯 Key Takeaways</div>
        
        <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); padding: 2rem; border-radius: 15px; margin: 2rem 0; border: 2px solid #28a745;">
            <h2 style="text-align: center; color: #155724; margin-bottom: 1.5rem;">📋 DIE WICHTIGSTEN ERKENNTNISSE</h2>
        </div>
        
        <div class="key-takeaway">
            <p style="margin: 0; font-size: 16px; line-height: 1.6;"><strong>1.</strong> Ein AVWAP Pinch ist eine <strong>Verengung der Preisspanne</strong>.</p>
        </div>
        
        <div class="key-takeaway">
            <p style="margin: 0; font-size: 16px; line-height: 1.6;"><strong>2.</strong> Der Ausbruch aus dem Pinch führt oft zu <strong>exzellenten Trend-Trades</strong>.</p>
        </div>
        
        <div class="key-takeaway">
            <p style="margin: 0; font-size: 16px; line-height: 1.6;"><strong>3.</strong> Der Aktionspunkt eines AVWAP Pinch ist, wenn er <strong>aus seiner Konsolidierung ausbricht</strong>.</p>
        </div>
        
        <div class="key-takeaway">
            <p style="margin: 0; font-size: 16px; line-height: 1.6;"><strong>4.</strong> Der ideale Zeitpunkt, eine Aktie zu kaufen, ist beim <strong>Ausbruch aus einer engen Range</strong>. Der frühe Einstieg in einen entstehenden Trend gibt uns zwei Vorteile: <strong>Maximales Gewinnpotenzial</strong> und <strong>minimales Risiko</strong> durch enge Stops.</p>
        </div>
        
        <div class="key-takeaway">
            <p style="margin: 0; font-size: 16px; line-height: 1.6;"><strong>5.</strong> Es ist wichtiger, die <strong>Psychologie</strong> zu verstehen, wie ein Pinch entsteht, als einfach nur Muster zu erkennen.</p>
        </div>
        
        <div class="key-takeaway">
            <p style="margin: 0; font-size: 16px; line-height: 1.6;"><strong>6.</strong> Nicht alle Pinches lösen sich in Richtung des primären Trends auf, weshalb wir auf <strong>Preisbestätigung warten</strong>, bevor wir einsteigen.</p>
        </div>
        
        <div class="key-takeaway">
            <p style="margin: 0; font-size: 16px; line-height: 1.6;"><strong>7.</strong> AVWAP Pinches entstehen und sind <strong>auf allen Zeitrahmen handelbar</strong>.</p>
        </div>
        
        <!-- Abschluss-Quiz -->
        <div class="section-title">🏆 Abschluss-Quiz</div>
        
        <div class="quiz-section">
            <h3>📝 Finales Quiz - Teste dein Gesamtverständnis</h3>
            
            <div class="quiz-question">
                <p><strong>Ein AVWAP Pinch zeigt:</strong></p>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Einen klaren Kauf</div>
                <div class="quiz-option" data-quiz="final" data-answer="correct" onclick="selectQuizOption(this)">Eine Energie-Kompression</div>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Einen Verkauf</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Der beste Einstiegszeitpunkt ist:</strong></p>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Im Pinch</div>
                <div class="quiz-option" data-quiz="final" data-answer="correct" onclick="selectQuizOption(this)">Beim bestätigten Ausbruch</div>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Nach dem Pinch</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Je enger der Pinch:</strong></p>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Desto unwichtiger</div>
                <div class="quiz-option" data-quiz="final" data-answer="correct" onclick="selectQuizOption(this)">Desto kraftvoller der potenzielle Ausbruch</div>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Desto riskanter</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Risk Management bedeutet:</strong></p>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Große Stops</div>
                <div class="quiz-option" data-quiz="final" data-answer="correct" onclick="selectQuizOption(this)">Enge Stops mit R-Multiple</div>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Keine Stops</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>AVWAP Pinches funktionieren:</strong></p>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Nur auf Tages-Charts</div>
                <div class="quiz-option" data-quiz="final" data-answer="correct" onclick="selectQuizOption(this)">Auf allen Zeitrahmen</div>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Nur intraday</div>
            </div>
            
            <div class="quiz-question">
                <p><strong>Die wichtigste Regel ist:</strong></p>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Sofort kaufen</div>
                <div class="quiz-option" data-quiz="final" data-answer="correct" onclick="selectQuizOption(this)">Auf Preisbestätigung warten</div>
                <div class="quiz-option" data-quiz="final" data-answer="wrong" onclick="selectQuizOption(this)">Immer shorten</div>
            </div>
            
            <button class="btn" onclick="checkQuiz('final', 6)">🏆 Finale Antworten prüfen</button>
            <div id="final-result" class="quiz-result" style="display: none;"></div>
        </div>
        
        <!-- Kapitel-Abschluss -->
        <div class="completion-celebration" id="completion-celebration" style="display: none;">
            <h2 style="color: white; margin: 0 0 1rem 0;">🎉 Kapitel 5 Abgeschlossen!</h2>
            <h3 style="color: white; margin: 0 0 1rem 0;">"The AVWAP Pinch"</h3>
            <p style="font-size: 18px; margin: 0;">
            Du hast erfolgreich alle Aspekte des AVWAP Pinch gemeistert!
            </p>
        </div>
        
        <div id="completion-summary" style="display: none;">
            <p><strong>🏆 Was du gelernt hast:</strong></p>
            <ul>
                <li>✅ Einen Pinch erkennen und verstehen</li>
                <li>✅ Den perfekten Einstiegszeitpunkt identifizieren</li>
                <li>✅ Risk Management mit engen Stops</li>
                <li>✅ Die Psychologie hinter dem Pinch</li>
                <li>✅ Praktische Anwendung auf allen Zeitrahmen</li>
            </ul>
            
            <p><strong>🚀 Nächste Schritte:</strong></p>
            <ol>
                <li>Übe das Erkennen von Pinches auf verschiedenen Charts</li>
                <li>Setze Alerts für potenzielle Pinch-Ausbrüche</li>
                <li>Führe ein Trading-Journal für deine Pinch-Trades</li>
                <li>Analysiere erfolgreiche und gescheiterte Pinches</li>
            </ol>
            
            <p><strong>💡 Denke daran:</strong></p>
            <blockquote style="font-style: italic; color: #059669; font-size: 16px; margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #059669;">
            "Energy and persistence conquer all things." - Benjamin Franklin
            </blockquote>
            
            <p>Der AVWAP Pinch ist ein kraftvolles Tool, aber wie alle Trading-Strategien erfordert er 
            <strong>Geduld</strong>, <strong>Disziplin</strong> und <strong>kontinuierliches Lernen</strong>.</p>
        </div>
    </div>
    
    <!-- Reset und Quiz-Zusammenfassung -->
    <div id="controls-section" style="display: none;">
        <hr style="margin: 2rem 0;">
        <button class="btn secondary" onclick="resetModule()">🔄 Kapitel neu starten</button>
        
        <div id="quiz-summary" style="margin-top: 2rem;">
            <h3>📊 Deine Quiz-Ergebnisse:</h3>
            <div class="progress-bar" style="margin: 1rem 0;">
                <div class="progress-fill" id="quiz-progress-fill" style="width: 0%;"></div>
            </div>
            <p id="quiz-summary-text"><strong>Gesamtpunktzahl: 0/0 (0%)</strong></p>
        </div>
    </div>
</div>

<script>
// Session State Management
let currentStep = {{ session.get('pinch_step', 0) }};
let quizScores = {{ session.get('pinch_quiz_scores', {}) | tojson }};
let debugMode = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    showCurrentStep();
    updateQuizSummary();
});

// Progress Management
function updateProgress() {
    const progressText = document.getElementById('progress-text');
    const progressFill = document.getElementById('progress-fill');
    
    if (progressText && progressFill) {
        progressText.textContent = currentStep;
        const percentage = (currentStep / 6) * 100;
        progressFill.style.width = percentage + '%';
    }
}

function showCurrentStep() {
    // Hide all steps
    const allSteps = document.querySelectorAll('.step-content');
    allSteps.forEach(step => {
        step.classList.remove('active');
    });
    
    // Show steps up to current step
    for (let i = 0; i <= currentStep; i++) {
        const step = document.getElementById(`step-${i}`);
        if (step) {
            step.classList.add('active');
        }
    }
    
    // Show controls if we're past step 0
    if (currentStep > 0) {
        const controlsSection = document.getElementById('controls-section');
        if (controlsSection) {
            controlsSection.style.display = 'block';
        }
    }
    
    // Show completion elements if we're at step 6
    if (currentStep >= 6) {
        const celebration = document.getElementById('completion-celebration');
        const summary = document.getElementById('completion-summary');
        if (celebration) celebration.style.display = 'block';
        if (summary) summary.style.display = 'block';
    }
}

// Step Navigation
function nextStep() {
    if (currentStep < 6) {
        currentStep++;
        updateProgress();
        showCurrentStep();
        saveProgress();
        
        // Scroll to new content
        setTimeout(() => {
            const newStep = document.getElementById(`step-${currentStep}`);
            if (newStep) {
                newStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 100);
    }
}

function jumpToStep(step) {
    currentStep = parseInt(step);
    updateProgress();
    showCurrentStep();
    saveProgress();
}

// Quiz Management
function selectQuizOption(element) {
    const quizName = element.getAttribute('data-quiz');
    const siblings = document.querySelectorAll(`[data-quiz="${quizName}"]`);
    
    // Remove selection from siblings
    siblings.forEach(sibling => {
        sibling.classList.remove('selected');
    });
    
    // Add selection to clicked element
    element.classList.add('selected');
}

function checkQuiz(quizName, totalQuestions) {
    const selectedOptions = document.querySelectorAll(`[data-quiz="${quizName}"].selected`);
    let score = 0;
    
    selectedOptions.forEach(option => {
        if (option.getAttribute('data-answer') === 'correct') {
            score++;
        }
    });
    
    // Store score
    quizScores[quizName] = score;
    
    // Show result
    const resultDiv = document.getElementById(`${quizName}-result`);
    if (resultDiv) {
        resultDiv.style.display = 'block';
        
        let message = '';
        let className = '';
        
        if (score === totalQuestions) {
            message = `🎉 Perfekt! Du hast ${score}/${totalQuestions} Punkten!`;
            className = 'success';
            
            // Special celebration for final quiz
            if (quizName === 'final') {
                // Add confetti effect
                setTimeout(() => {
                    createConfetti();
                }, 500);
            }
        } else if (score >= Math.ceil(totalQuestions * 0.67)) {
            message = `👍 Gut gemacht! Du hast ${score}/${totalQuestions} Punkten!`;
            className = 'success';
        } else {
            message = `📖 Du hast ${score}/${totalQuestions} Punkten. Wiederhole nochmal die Konzepte.`;
            className = 'warning';
        }
        
        resultDiv.textContent = message;
        resultDiv.className = `quiz-result ${className}`;
    }
    
    updateQuizSummary();
    saveProgress();
}

function updateQuizSummary() {
    const summaryDiv = document.getElementById('quiz-summary');
    if (!summaryDiv) return;
    
    let totalScore = 0;
    let totalPossible = 0;
    
    Object.keys(quizScores).forEach(quizName => {
        totalScore += quizScores[quizName];
        if (quizName === 'final') {
            totalPossible += 6; // Final quiz has 6 questions
        } else {
            totalPossible += 3; // Regular quizzes have 3 questions
        }
    });
    
    const percentage = totalPossible > 0 ? (totalScore / totalPossible) * 100 : 0;
    
    const progressFill = document.getElementById('quiz-progress-fill');
    const summaryText = document.getElementById('quiz-summary-text');
    
    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }
    
    if (summaryText) {
        summaryText.innerHTML = `<strong>Gesamtpunktzahl: ${totalScore}/${totalPossible} (${percentage.toFixed(1)}%)</strong>`;
    }
}

// Save progress to server
function saveProgress() {
    fetch('/avwap-pinch/update-progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            step: currentStep,
            quiz_scores: quizScores
        })
    })
    .catch(error => {
        console.error('Error saving progress:', error);
    });
}

// Reset module
function resetModule() {
    if (confirm('Möchtest du wirklich das Kapitel neu starten? Alle Fortschritte gehen verloren.')) {
        currentStep = 0;
        quizScores = {};
        updateProgress();
        showCurrentStep();
        updateQuizSummary();
        saveProgress();
        
        // Reset all quiz selections
        document.querySelectorAll('.quiz-option.selected').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Hide all quiz results
        document.querySelectorAll('.quiz-result').forEach(result => {
            result.style.display = 'none';
        });
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Debug Mode
function toggleDebug() {
    debugMode = !debugMode;
    const debugControls = document.getElementById('debug-controls');
    if (debugControls) {
        debugControls.classList.toggle('active', debugMode);
    }
}

// Confetti effect for completion
function createConfetti() {
    const colors = ['#f43f5e', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-10px';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.pointerEvents = 'none';
        confetti.style.zIndex = '9999';
        confetti.style.borderRadius = '50%';
        
        document.body.appendChild(confetti);
        
        // Animate confetti falling
        const animation = confetti.animate([
            { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
            { transform: `translateY(100vh) rotate(720deg)`, opacity: 0 }
        ], {
            duration: 3000 + Math.random() * 2000,
            easing: 'cubic-bezier(0.5, 0, 0.5, 1)'
        });
        
        animation.onfinish = () => {
            confetti.remove();
        };
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (debugMode) {
        if (e.key === 'ArrowRight' && currentStep < 6) {
            nextStep();
        } else if (e.key === 'ArrowLeft' && currentStep > 0) {
            currentStep--;
            updateProgress();
            showCurrentStep();
            saveProgress();
        }
    }
});
</script>

{% endblock %}
