{% extends "base.html" %}

{% block title %}Admin - Vollständige Menü-Verwaltung{% endblock %}

{% block header_title %}🗂️ Vollständige Menü-Verwaltung{% endblock %}
{% block header_subtitle %}Alle Module verwalten - Reihenfolge, Status, Zugriff und Lead-Magnete{% endblock %}

{% block content %}
            
<!-- Statistiken Dashboard -->
<div class="card mb-4">
    <h2>📊 Übersicht</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px;">
        <div style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ modules|length }}</div>
            <div>Gesamt Module</div>
        </div>
        <div style="background: linear-gradient(135deg, var(--success), #047857); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ modules|selectattr('is_published')|list|length }}</div>
            <div>Veröffentlicht</div>
        </div>
        <div style="background: linear-gradient(135deg, var(--gold-classic), var(--gold-dark)); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ modules|selectattr('is_lead_magnet')|list|length }}</div>
            <div>Lead-Magnete</div>
        </div>
        <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ modules|selectattr('content_type', 'equalto', 'streamlit')|list|length }}</div>
            <div>Streamlit Module</div>
        </div>
    </div>
</div>

<!-- Schnell-Aktionen -->
<div class="card mb-4">
    <h2>⚡ Schnell-Aktionen</h2>
    <div style="display: flex; gap: 15px; flex-wrap: wrap; padding: 20px;">
        <button class="btn" onclick="showAddCategoryModal()">
            ➕ Hauptkategorie hinzufügen
        </button>
        <button class="btn" onclick="showAddSubcategoryModal()">
            ➕ Unterkategorie hinzufügen
        </button>
        <button class="btn" onclick="showAddModuleModal()" style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white;">
            📄 Neues Modul hinzufügen
        </button>
        <a href="{{ url_for('force_sync_templates') }}" 
           class="btn primary" 
           style="background: linear-gradient(135deg, var(--success), #047857);"
           onclick="return confirm('🔄 Alle Templates synchronisieren?\n\nDies scannt den templates-Ordner nach neuen HTML-Dateien und fügt sie zur Kategorie \'🆕 Neue Module\' hinzu.')">
            🔄 Templates synchronisieren
        </a>
        <button class="btn primary" onclick="autoRegisterModules()" style="background: linear-gradient(135deg, #10b981, #059669);">
            🚀 Module auto-registrieren
        </button>
        <a href="{{ url_for('admin_register_missing_modules') }}"
           class="btn"
           style="background: linear-gradient(135deg, #10b981, #059669); color: white;"
           onclick="return confirm('🔍 Fehlende Module suchen?\n\nDies scannt den templates-Ordner und fügt alle noch nicht registrierten Module zur Kategorie \'🆕 Neue Module\' hinzu.')">
            🔍 Fehlende Module finden
        </a>
        <a href="{{ url_for('admin_analytics') }}" 
           class="btn" 
           style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;"
           onclick="console.log('Analytics Button geklickt!'); console.log('URL:', '{{ url_for('admin_analytics') }}'); return true;">
            📊 Analytics Dashboard
        </a>
        <a href="{{ url_for('admin_analytics_test') }}" 
           class="btn" 
           style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
            🧪 Analytics Test
        </a>
        <a href="{{ url_for('fix_duplicate_categories') }}" 
           class="btn secondary" 
           onclick="return confirm('🔧 Doppelte Kategorien bereinigen?\n\nDies führt doppelte Kategorien zusammen und verschiebt alle Module zur ersten Kategorie.')">
            🔧 Duplikate bereinigen
        </a>
        <button class="btn secondary" onclick="toggleBulkMode()">
            ☑️ Bulk-Auswahl
        </button>
        <button class="btn secondary" onclick="toggleSortMode()">
            🔀 Reihenfolge ändern
        </button>
        <button class="btn secondary" onclick="exportModules()">
            📤 Module exportieren
        </button>
        <a href="{{ url_for('admin_init_database') }}" 
           class="btn" 
           style="background: linear-gradient(135deg, #10b981, #059669); color: white;"
           onclick="return confirm('Database neu initialisieren? Dies erstellt fehlende Tabellen.')">
            🗄️ Database initialisieren
        </a>
        <button class="btn secondary" onclick="showBulkActions()" id="bulkActionsBtn" style="display: none;">
            🔧 Bulk-Aktionen
        </button>
    </div>
</div>

<!-- 3-Ebenen Kategorien-Struktur -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2>🗂️ 3-Ebenen Kategorien-Struktur</h2>
        <div class="view-toggle">
            <button class="btn btn-sm" onclick="switchView('hierarchy')" id="hierarchyViewBtn">🌳 Hierarchie</button>
            <button class="btn btn-sm secondary" onclick="switchView('list')" id="listViewBtn">📋 Liste</button>
        </div>
    </div>
    
    <!-- Hierarchische Ansicht -->
    <div class="card-body" id="hierarchyContainer">
        <div id="categoryTree" class="category-tree">
            {% for category in categories %}
            <div class="category-level-1" data-category-id="{{ category.id }}">
                <div class="category-header level-1" onclick="toggleCategory({{ category.id }}); console.log('Header clicked for category {{ category.id }}');">
                    <span class="expand-icon" id="expand-{{ category.id }}">▶</span>
                    <span class="category-icon">{{ category.icon }}</span>
                    <span class="category-name">{{ category.name }}</span>
                    <span class="category-stats">({{ category.subcategories|length }} Unterkategorien, {{ category.modules|length }} Module)</span>
                    <div class="category-actions" onclick="event.stopPropagation();">
                        <button class="action-btn" onclick="editCategory({{ category.id }});" title="Bearbeiten">✏️</button>
                        <button class="action-btn" onclick="addSubcategory({{ category.id }});" title="Unterkategorie hinzufügen">➕</button>
                        <button class="action-btn" onclick="toggleCategoryStatus({{ category.id }});" title="{% if category.is_active %}Deaktivieren{% else %}Aktivieren{% endif %}">
                            {% if category.is_active %}✅{% else %}❌{% endif %}
                        </button>
                        <button class="action-btn danger" onclick="deleteCategory({{ category.id }});" title="Löschen">🗑️</button>
                    </div>
                </div>
                
                <div class="category-content level-1" id="category-{{ category.id }}" style="display: none;">
                    <!-- Unterkategorien -->
                    {% for subcategory in category.subcategories %}
                    <div class="category-level-2" data-subcategory-id="{{ subcategory.id }}">
                        <div class="category-header level-2" onclick="toggleSubcategory({{ subcategory.id }}); console.log('Header clicked for subcategory {{ subcategory.id }}');">
                            <span class="expand-icon" id="expand-sub-{{ subcategory.id }}">▶</span>
                            <span class="category-icon">{{ subcategory.icon }}</span>
                            <span class="category-name">{{ subcategory.name }}</span>
                            <span class="category-stats">({{ subcategory.modules|length }} Module)</span>
                            <div class="category-actions" onclick="event.stopPropagation();">
                                <button class="action-btn" onclick="editSubcategory({{ subcategory.id }});" title="Bearbeiten">✏️</button>
                                <button class="action-btn" onclick="toggleSubcategoryStatus({{ subcategory.id }});" title="{% if subcategory.is_active %}Deaktivieren{% else %}Aktivieren{% endif %}">
                                    {% if subcategory.is_active %}✅{% else %}❌{% endif %}
                                </button>
                                <button class="action-btn danger" onclick="deleteSubcategory({{ subcategory.id }});" title="Löschen">🗑️</button>
                            </div>
                        </div>
                        
                        <div class="category-content level-2" id="subcategory-{{ subcategory.id }}" style="display: none;">
                            <!-- Module in dieser Unterkategorie -->
                            {% for module in subcategory.modules|sort(attribute='sort_order') %}
                            <div class="module-item level-3" data-module-id="{{ module.id }}" draggable="false">
                                <div class="drag-handle" title="Ziehen zum Sortieren" style="display: none;">⋮⋮</div>
                                <span class="module-icon">{{ module.icon }}</span>
                                <div class="module-info">
                                    <span class="module-title">{{ module.title }}</span>
                                    <div class="module-badges">
                                        {% if module.is_lead_magnet %}
                                        <span class="badge free">🆓 Kostenlos</span>
                                        {% elif 'elite' in (module.required_subscription_levels or []) %}
                                        <span class="badge elite">👑 Elite</span>
                                        {% elif 'premium' in (module.required_subscription_levels or []) %}
                                        <span class="badge premium">💰 Premium</span>
                                        {% else %}
                                        <span class="badge basic">🔓 Basic</span>
                                        {% endif %}
                                        
                                        {% if module.is_published %}
                                        <span class="badge published">✅ Live</span>
                                        {% else %}
                                        <span class="badge draft">📝 Entwurf</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="module-actions">
                                    <select onchange="changeModuleSubscription({{ module.id }}, this.value)" class="subscription-select">
                                        <option value="free" {% if module.is_lead_magnet %}selected{% endif %}>🆓 Kostenlos</option>
                                        <option value="basic" {% if not module.is_lead_magnet and not module.required_subscription_levels %}selected{% endif %}>🔓 Basic</option>
                                        <option value="premium" {% if 'premium' in (module.required_subscription_levels or []) %}selected{% endif %}>💰 Premium</option>
                                        <option value="elite" {% if 'elite' in (module.required_subscription_levels or []) %}selected{% endif %}>👑 Elite</option>
                                    </select>
                                    <button class="action-btn" onclick="moveModule({{ module.id }})" title="Modul verschieben">📁</button>
                                    {% if module.category and module.category.slug == 'neue-module' %}
                                    <button class="action-btn" onclick="quickMoveModule({{ module.id }}, '{{ module.title }}')" title="📦 Schnell verschieben" style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: bold;">📦</button>
                                    {% endif %}
                                    <button class="action-btn" onclick="toggleModuleStatus({{ module.id }}, 'published')" title="{% if module.is_published %}Verstecken{% else %}Veröffentlichen{% endif %}">
                                        {% if module.is_published %}👁️{% else %}🔒{% endif %}
                                    </button>
                                    {% if module.slug %}
                                    <a href="{{ url_for('module_view', slug=module.slug) }}" class="action-btn" title="Anzeigen: {{ module.slug }}">👁️</a>
                                    {% else %}
                                    <span class="action-btn disabled" title="Kein Slug vorhanden">❌</span>
                                    {% endif %}
                                    <button class="action-btn danger" onclick="deleteModule({{ module.id }}, '{{ module.title }}')" title="Modul löschen">🗑️</button>
                                    <button class="action-btn" onclick="changeModuleSortOrder({{ module.id }}, {{ module.sort_order }})" title="Reihenfolge ändern">🔢</button>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <!-- Nicht zugeordnete Module zu dieser Unterkategorie hinzufügen -->
                            <div class="add-module-zone" onclick="showMoveModuleToSubcategory({{ subcategory.id }})">
                                ➕ Module hierher verschieben
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Module direkt in Hauptkategorie (ohne Unterkategorie) -->
                    {% for module in category.modules %}
                    {% if not module.subcategory_id %}
                    <div class="module-item level-2" data-module-id="{{ module.id }}">
                        <div class="drag-handle" title="Ziehen zum Sortieren">⋮⋮</div>
                        <span class="module-icon">{{ module.icon }}</span>
                        <div class="module-info">
                            <span class="module-title">{{ module.title }}</span>
                            <div class="module-badges">
                                {% if module.is_lead_magnet %}
                                <span class="badge free">🆓 Kostenlos</span>
                                {% elif 'elite' in (module.required_subscription_levels or []) %}
                                <span class="badge elite">👑 Elite</span>
                                {% elif 'premium' in (module.required_subscription_levels or []) %}
                                <span class="badge premium">💰 Premium</span>
                                {% else %}
                                <span class="badge basic">🔓 Basic</span>
                                {% endif %}
                                
                                {% if module.is_published %}
                                <span class="badge published">✅ Live</span>
                                {% else %}
                                <span class="badge draft">📝 Entwurf</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="module-actions">
                            <select onchange="changeModuleSubscription({{ module.id }}, this.value)" class="subscription-select">
                                <option value="free" {% if module.is_lead_magnet %}selected{% endif %}>🆓 Kostenlos</option>
                                <option value="basic" {% if not module.is_lead_magnet and not module.required_subscription_levels %}selected{% endif %}>🔓 Basic</option>
                                <option value="premium" {% if 'premium' in (module.required_subscription_levels or []) %}selected{% endif %}>💰 Premium</option>
                                <option value="elite" {% if 'elite' in (module.required_subscription_levels or []) %}selected{% endif %}>👑 Elite</option>
                            </select>
                            <button class="action-btn" onclick="moveModule({{ module.id }})" title="Modul verschieben">📁</button>
                            {% if module.category and module.category.slug == 'neue-module' %}
                            <button class="action-btn" onclick="quickMoveModule({{ module.id }}, '{{ module.title }}')" title="📦 Schnell verschieben" style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: bold;">📦</button>
                            {% endif %}
                            <button class="action-btn" onclick="toggleModuleStatus({{ module.id }}, 'published')" title="{% if module.is_published %}Verstecken{% else %}Veröffentlichen{% endif %}">
                                {% if module.is_published %}👁️{% else %}🔒{% endif %}
                            </button>
                            {% if module.slug %}
                            <a href="{{ url_for('module_view', slug=module.slug) }}" class="action-btn" title="Anzeigen: {{ module.slug }}">👁️</a>
                            {% else %}
                            <span class="action-btn disabled" title="Kein Slug vorhanden">❌</span>
                            {% endif %}
                            <button class="action-btn danger" onclick="deleteModule({{ module.id }}, '{{ module.title }}')" title="Modul löschen">🗑️</button>
                            <button class="action-btn" onclick="changeModuleSortOrder({{ module.id }}, {{ module.sort_order }})" title="Reihenfolge ändern">🔢</button>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            
            <!-- Nicht zugeordnete Module -->
            {% set unassigned_modules = modules|selectattr('category_id', 'none')|list %}
            {% if unassigned_modules %}
            <div class="category-level-1 unassigned">
                <div class="category-header level-1" onclick="toggleUnassigned()">
                    <span class="expand-icon" id="expand-unassigned">▶</span>
                    <span class="category-icon">📦</span>
                    <span class="category-name">Nicht zugeordnete Module</span>
                    <span class="category-stats">({{ unassigned_modules|length }} Module)</span>
                </div>
                
                <div class="category-content level-1" id="unassigned-modules" style="display: none;">
                    {% for module in unassigned_modules %}
                    <div class="module-item level-2 unassigned" data-module-id="{{ module.id }}">
                        <div class="drag-handle" title="Ziehen zum Sortieren">⋮⋮</div>
                        <span class="module-icon">{{ module.icon }}</span>
                        <div class="module-info">
                            <span class="module-title">{{ module.title }}</span>
                            <div class="module-badges">
                                {% if module.is_lead_magnet %}
                                <span class="badge free">🆓 Kostenlos</span>
                                {% elif 'elite' in (module.required_subscription_levels or []) %}
                                <span class="badge elite">👑 Elite</span>
                                {% elif 'premium' in (module.required_subscription_levels or []) %}
                                <span class="badge premium">💰 Premium</span>
                                {% else %}
                                <span class="badge basic">🔓 Basic</span>
                                {% endif %}
                                
                                {% if module.is_published %}
                                <span class="badge published">✅ Live</span>
                                {% else %}
                                <span class="badge draft">📝 Entwurf</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="module-actions">
                            <select onchange="changeModuleSubscription({{ module.id }}, this.value)" class="subscription-select">
                                <option value="free" {% if module.is_lead_magnet %}selected{% endif %}>🆓 Kostenlos</option>
                                <option value="basic" {% if not module.is_lead_magnet and not module.required_subscription_levels %}selected{% endif %}>🔓 Basic</option>
                                <option value="premium" {% if 'premium' in (module.required_subscription_levels or []) %}selected{% endif %}>💰 Premium</option>
                                <option value="elite" {% if 'elite' in (module.required_subscription_levels or []) %}selected{% endif %}>👑 Elite</option>
                            </select>
                            <button class="action-btn" onclick="moveModule({{ module.id }})" title="Modul verschieben">📁</button>
                            {% if module.category and module.category.slug == 'neue-module' %}
                            <button class="action-btn" onclick="quickMoveModule({{ module.id }}, '{{ module.title }}')" title="📦 Schnell verschieben" style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: bold;">📦</button>
                            {% endif %}
                            <button class="action-btn" onclick="toggleModuleStatus({{ module.id }}, 'published')" title="{% if module.is_published %}Verstecken{% else %}Veröffentlichen{% endif %}">
                                {% if module.is_published %}👁️{% else %}🔒{% endif %}
                            </button>
                            {% if module.slug %}
                            <a href="{{ url_for('module_view', slug=module.slug) }}" class="action-btn" title="Anzeigen: {{ module.slug }}">👁️</a>
                            {% else %}
                            <span class="action-btn disabled" title="Kein Slug vorhanden">❌</span>
                            {% endif %}
                            <button class="action-btn danger" onclick="deleteModule({{ module.id }}, '{{ module.title }}')" title="Modul löschen">🗑️</button>
                            <button class="action-btn" onclick="changeModuleSortOrder({{ module.id }}, {{ module.sort_order }})" title="Reihenfolge ändern">🔢</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Klassische Modul-Liste (Alternative Ansicht) -->
<div class="card" id="listContainer" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2>📋 Alle Module - Liste</h2>
    </div>
    
    <!-- Filter und Suche -->
    <div class="card-body border-bottom">
        <div class="row">
            <div class="col-md-4">
                <input type="text" id="searchModules" class="form-input" placeholder="🔍 Module durchsuchen..." onkeyup="filterModules()">
            </div>
            <div class="col-md-3">
                <select id="filterCategory" class="form-select" onchange="filterModules()">
                    <option value="">Alle Kategorien</option>
                    {% for module in modules %}
                        {% if module.category and module.category.name not in (categories_seen or []) %}
                            {% set _ = categories_seen.append(module.category.name) if categories_seen else None %}
                            {% set categories_seen = categories_seen or [module.category.name] %}
                            <option value="{{ module.category.name }}">{{ module.category.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select id="filterStatus" class="form-select" onchange="filterModules()">
                    <option value="">Alle Status</option>
                    <option value="published">Nur Veröffentlicht</option>
                    <option value="draft">Nur Entwürfe</option>
                    <option value="lead_magnet">Nur Lead-Magnete</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn secondary w-100" onclick="clearFilters()">🔄 Reset</button>
            </div>
        </div>
    </div>
    
    <!-- Module Grid/List View -->
    <div class="card-body" id="modulesContainer">
        <div id="modulesList" class="modules-list">
            {% for module in modules|sort(attribute='sort_order') %}
            <div class="module-item" data-module-id="{{ module.id }}" 
                 data-category="{{ module.category.name if module.category else '' }}"
                 data-status="{% if module.is_published %}published{% else %}draft{% endif %}"
                 data-lead-magnet="{{ module.is_lead_magnet }}">
                
                <!-- Drag Handle -->
                <div class="drag-handle" title="Ziehen zum Sortieren">⋮⋮</div>
                
                <!-- Bulk Checkbox -->
                <input type="checkbox" class="bulk-checkbox" value="{{ module.id }}" onchange="updateBulkActions()" style="display: none;">
                
                <!-- Module Content -->
                <div class="module-content">
                    <div class="module-header">
                        <div class="module-info">
                            <span class="module-icon">{{ module.icon }}</span>
                            <div class="module-details">
                                <h4 class="module-title" onclick="editModuleInline({{ module.id }})">{{ module.title }}</h4>
                                <p class="module-description">{{ module.description or 'Keine Beschreibung' }}</p>
                                <div class="module-meta">
                                    {% if module.category %}
                                    <span class="badge category-badge">{{ module.category.name }}</span>
                                    {% endif %}
                                    <span class="badge type-badge">{{ module.content_type|upper }}</span>
                                    <span class="badge duration-badge">{{ module.estimated_duration }}min</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="module-actions">
                            <!-- Status Toggle -->
                            <button class="action-btn {% if module.is_published %}published{% else %}draft{% endif %}" 
                                    onclick="toggleModuleStatus({{ module.id }}, 'published')"
                                    title="{% if module.is_published %}Verstecken{% else %}Veröffentlichen{% endif %}">
                                {% if module.is_published %}👁️{% else %}🔒{% endif %}
                            </button>
                            
                            <!-- Lead Magnet Toggle -->
                            <button class="action-btn {% if module.is_lead_magnet %}lead-magnet{% else %}premium{% endif %}" 
                                    onclick="toggleModuleStatus({{ module.id }}, 'lead_magnet')"
                                    title="{% if module.is_lead_magnet %}Lead-Magnet deaktivieren{% else %}Lead-Magnet aktivieren{% endif %}">
                                {% if module.is_lead_magnet %}🧲{% else %}💎{% endif %}
                            </button>
                            
                            <!-- Access Level -->
                            <button class="action-btn access-level" onclick="editModuleAccess({{ module.id }})" title="Zugriffslevel ändern">
                                {% if module.is_lead_magnet %}
                                    🆓
                                {% elif 'elite' in (module.required_subscription_levels or []) %}
                                    👑
                                {% elif 'premium' in (module.required_subscription_levels or []) %}
                                    💰
                                {% else %}
                                    🔓
                                {% endif %}
                            </button>
                            
                            <!-- Edit -->
                            <button class="action-btn edit" onclick="editModule({{ module.id }})" title="Bearbeiten">✏️</button>
                            
                            <!-- View -->
                            {% if module.slug %}
                            <a href="{{ url_for('module_view', slug=module.slug) }}" class="action-btn view" title="Anzeigen: {{ module.slug }}">👁️</a>
                            {% else %}
                            <span class="action-btn view disabled" title="Kein Slug vorhanden">❌</span>
                            {% endif %}
                            
                            <!-- Delete -->
                            <button class="action-btn danger" onclick="deleteModule({{ module.id }}, '{{ module.title }}')" title="Modul löschen">🗑️</button>
                            
                            <!-- More Options -->
                            <button class="action-btn more" onclick="showModuleOptions({{ module.id }})" title="Mehr Optionen">⋯</button>
                        </div>
                    </div>
                    
                    <!-- Expanded Details (initially hidden) -->
                    <div class="module-details-expanded" id="details-{{ module.id }}" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Sortierung:</label>
                                <input type="number" value="{{ module.sort_order }}" onchange="updateSortOrder({{ module.id }}, this.value)">
                            </div>
                            <div class="detail-item">
                                <label>Schwierigkeit:</label>
                                <select onchange="updateModuleField({{ module.id }}, 'difficulty_level', this.value)">
                                    <option value="beginner" {% if module.difficulty_level == 'beginner' %}selected{% endif %}>Anfänger</option>
                                    <option value="intermediate" {% if module.difficulty_level == 'intermediate' %}selected{% endif %}>Fortgeschritten</option>
                                    <option value="advanced" {% if module.difficulty_level == 'advanced' %}selected{% endif %}>Experte</option>
                                </select>
                            </div>
                            <div class="detail-item">
                                <label>Dauer (Min):</label>
                                <input type="number" value="{{ module.estimated_duration }}" onchange="updateModuleField({{ module.id }}, 'estimated_duration', this.value)">
                            </div>
                            {% if module.external_url %}
                            <div class="detail-item full-width">
                                <label>URL:</label>
                                <input type="url" value="{{ module.external_url }}" onchange="updateModuleField({{ module.id }}, 'external_url', this.value)">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Bulk Actions Panel (hidden by default) -->
<div id="bulkActionsPanel" class="card" style="display: none; margin-top: 20px;">
    <div class="card-header">
        <h3>🔧 Bulk-Aktionen</h3>
        <div class="bulk-selection-info">
            <span id="selectedCount">0</span> Module ausgewählt
        </div>
    </div>
    <div class="card-body">
        <div class="bulk-actions">
            <button class="btn" onclick="bulkAction('publish')">✅ Veröffentlichen</button>
            <button class="btn secondary" onclick="bulkAction('unpublish')">🔒 Verstecken</button>
            <button class="btn" onclick="bulkAction('lead_magnet')">🧲 Lead-Magnet</button>
            <button class="btn secondary" onclick="bulkAction('not_lead_magnet')">💎 Premium</button>
            <button class="btn warning" onclick="bulkAction('delete')">🗑️ Löschen</button>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="modal">
    <div class="modal-content">
        <h3>➕ Hauptkategorie hinzufügen</h3>
        <form action="{{ url_for('admin_add_category') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" name="name" class="form-input" placeholder="z.B. Technische Analyse" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Icon</label>
                <input type="text" name="icon" class="form-input" value="📊" placeholder="📊">
                </div>
            <div class="form-group">
                <label class="form-label">Beschreibung</label>
                <textarea name="description" class="form-input" rows="3" placeholder="Kurze Beschreibung der Kategorie"></textarea>
                </div>
            <div class="form-group">
                <label class="form-label">Sortierung</label>
                <input type="number" name="sort_order" class="form-input" value="100" min="1">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn secondary" onclick="closeModal('addCategoryModal')">Abbrechen</button>
                <button type="submit" class="btn">Kategorie erstellen</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Subcategory Modal -->
<div id="addSubcategoryModal" class="modal">
    <div class="modal-content">
        <h3>➕ Unterkategorie hinzufügen</h3>
        <form action="{{ url_for('admin_add_subcategory') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-group">
                <label class="form-label">Hauptkategorie *</label>
                <select name="category_id" class="form-select" required>
                    <option value="">Kategorie auswählen</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" name="name" class="form-input" placeholder="z.B. Moving Averages" required>
            </div>
            <div class="form-group">
                <label class="form-label">Icon</label>
                <input type="text" name="icon" class="form-input" value="📋" placeholder="📋">
            </div>
            <div class="form-group">
                <label class="form-label">Sortierung</label>
                <input type="number" name="sort_order" class="form-input" value="100" min="1">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn secondary" onclick="closeModal('addSubcategoryModal')">Abbrechen</button>
                <button type="submit" class="btn">Unterkategorie erstellen</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Module Modal -->
<div id="addModuleModal" class="modal">
    <div class="modal-content large">
        <h3>📄 Neues Flask HTML-Modul hinzufügen</h3>
        <form action="{{ url_for('add_module') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Titel *</label>
                    <input type="text" name="title" class="form-input" placeholder="z.B. Tirone Levels & Quadrant Lines" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Icon</label>
                    <input type="text" name="icon" class="form-input" value="📊" placeholder="📊">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Beschreibung *</label>
                    <textarea name="description" class="form-input" rows="3" placeholder="Detaillierte Beschreibung des Moduls..." required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Kategorie *</label>
                    <select name="category_id" class="form-select" required>
                        <option value="">Kategorie auswählen</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Unterkategorie</label>
                    <select name="subcategory_id" class="form-select">
                        <option value="">Direkt unter Hauptkategorie</option>
                        {% for category in categories %}
                            {% for subcategory in category.subcategories %}
                            <option value="{{ subcategory.id }}">{{ category.name }} > {{ subcategory.name }}</option>
                            {% endfor %}
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Template-Datei *</label>
                    <input type="text" name="template_file" class="form-input" placeholder="z.B. tirone_quadrant_lines.html" required>
                    <small style="color: #666; font-size: 0.85em;">Dateiname der HTML-Vorlage im templates/ Ordner</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Dauer (Min)</label>
                    <input type="number" name="estimated_duration" class="form-input" value="60" min="5" max="300">
                </div>
                <div class="form-group">
                    <label class="form-label">Schwierigkeit</label>
                    <select name="difficulty_level" class="form-select">
                        <option value="beginner">Anfänger</option>
                        <option value="intermediate" selected>Fortgeschritten</option>
                        <option value="advanced">Experte</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Externe URL (optional)</label>
                    <input type="url" name="external_url" class="form-input" placeholder="https://... (für externe Links)">
                </div>
            </div>
            
            <div class="form-section">
                <h4>🔒 Zugriffsberechtigung</h4>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin: 10px 0;">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_lead_magnet">
                        🎁 Lead-Magnet (kostenlos für alle)
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="req_free">
                        🆓 Free
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="req_premium" checked>
                        ⭐ Premium
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="req_elite" checked>
                        💎 Elite
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="req_elite_pro" checked>
                        👑 Elite Pro
                    </label>
                </div>
                <small style="color: #666; font-size: 0.85em;">Hinweis: Lead-Magnet ignoriert alle anderen Einstellungen. Sonst wählen Sie die Subscription-Levels, die Zugriff haben sollen.</small>
            </div>
            
            <div class="form-section">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_published">
                    ✅ Sofort veröffentlichen (sonst bleibt es Entwurf)
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" class="btn secondary" onclick="closeModal('addModuleModal')">Abbrechen</button>
                <button type="submit" class="btn">Modul erstellen</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="editCategoryModal" class="modal">
    <div class="modal-content">
        <h3>✏️ Kategorie bearbeiten</h3>
        <form action="{{ url_for('admin_edit_category') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="category_id" id="edit_category_id">
            <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" name="name" id="edit_category_name" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Icon</label>
                <input type="text" name="icon" id="edit_category_icon" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Beschreibung</label>
                <textarea name="description" id="edit_category_description" class="form-input" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Sortierung</label>
                <input type="number" name="sort_order" id="edit_category_sort_order" class="form-input" min="1">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn secondary" onclick="closeModal('editCategoryModal')">Abbrechen</button>
                <button type="submit" class="btn">Änderungen speichern</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Subcategory Modal -->
<div id="editSubcategoryModal" class="modal">
    <div class="modal-content">
        <h3>✏️ Unterkategorie bearbeiten</h3>
        <form action="{{ url_for('admin_edit_subcategory') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="subcategory_id" id="edit_subcategory_id">
            <div class="form-group">
                <label class="form-label">Hauptkategorie *</label>
                <select name="category_id" id="edit_subcategory_category_id" class="form-select" required>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" name="name" id="edit_subcategory_name" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Icon</label>
                <input type="text" name="icon" id="edit_subcategory_icon" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Sortierung</label>
                <input type="number" name="sort_order" id="edit_subcategory_sort_order" class="form-input" min="1">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn secondary" onclick="closeModal('editSubcategoryModal')">Abbrechen</button>
                <button type="submit" class="btn">Änderungen speichern</button>
            </div>
        </form>
    </div>
</div>

<!-- Move Module Modal -->
<div id="moveModuleModal" class="modal">
    <div class="modal-content">
        <h3>📁 Modul verschieben</h3>
        <form action="{{ url_for('admin_move_module') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="module_id" id="move_module_id">
            <div class="form-group">
                <label class="form-label">Ziel-Kategorie *</label>
                <select name="category_id" id="move_category_id" class="form-select" onchange="updateSubcategoryOptions()" required>
                    <option value="">Kategorie auswählen</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Unterkategorie (optional)</label>
                <select name="subcategory_id" id="move_subcategory_id" class="form-select">
                    <option value="">Keine Unterkategorie (direkt in Hauptkategorie)</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn secondary" onclick="closeModal('moveModuleModal')">Abbrechen</button>
                <button type="submit" class="btn">Modul verschieben</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Modern Admin Interface Styles */
.card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

/* 3-Ebenen Hierarchie Styles */
.category-tree {
    padding: 20px;
}

.category-level-1, .category-level-2 {
    margin-bottom: 15px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.category-level-1 {
    border: 2px solid #e5e7eb;
}

.category-level-1.unassigned {
    border: 2px solid #f59e0b;
    background: #fef3c7;
}

.category-level-2 {
    margin: 10px 0 10px 20px;
    border: 1px solid #d1d5db;
}

.category-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.category-header:hover {
    background: #f9fafb;
}

.category-header.level-1 {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
    border-bottom: 1px solid #e5e7eb;
}

.category-header.level-2 {
    background: linear-gradient(135deg, #fefefe, #f1f5f9);
    font-size: 14px;
    padding: 12px 15px;
}

.expand-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
    width: 15px;
    text-align: center;
}

.expand-icon.expanded {
    transform: rotate(90deg);
}

.category-icon {
    font-size: 18px;
    width: 25px;
    text-align: center;
}

.category-name {
    flex: 1;
    font-size: 16px;
}

.category-level-2 .category-name {
    font-size: 14px;
}

.category-stats {
    font-size: 12px;
    color: #6b7280;
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 12px;
}

.category-actions {
    display: flex;
    gap: 5px;
}

.category-content {
    padding: 15px;
    background: white;
}

.category-content.level-1 {
    background: #fafbfc;
}

.category-content.level-2 {
    background: white;
    padding: 10px;
    transition: all 0.3s ease;
}

/* Module Items in Hierarchie */
.module-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    margin: 8px 0;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
}

.module-item:hover {
    border-color: var(--gold-classic);
    box-shadow: 0 2px 8px rgba(218, 165, 32, 0.15);
}

.module-item.level-2 {
    margin-left: 0;
}

.module-item.level-3 {
    margin-left: 20px;
    background: #f9fafb;
}

.module-item.unassigned {
    border-color: #f59e0b;
    background: #fffbeb;
}

.module-icon {
    font-size: 18px;
    width: 25px;
    text-align: center;
}

.module-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.module-title {
    font-weight: 600;
    color: var(--primary-dark);
    margin: 0;
}

.module-badges {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge.free {
    background: #dcfce7;
    color: #166534;
}

.badge.basic {
    background: #e0f2fe;
    color: #0c4a6e;
}

.badge.premium {
    background: #fef3c7;
    color: #92400e;
}

.badge.elite {
    background: #fce7f3;
    color: #831843;
}

.badge.published {
    background: #dcfce7;
    color: #166534;
}

.badge.draft {
    background: #fed7aa;
    color: #9a3412;
}

.module-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.subscription-select {
    padding: 4px 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 12px;
    background: white;
    min-width: 120px;
}

.subscription-select:focus {
    outline: none;
    border-color: var(--primary-medium);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.add-module-zone {
    padding: 15px;
    margin: 10px 0;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    text-align: center;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.3s ease;
}

.add-module-zone:hover {
    border-color: var(--gold-classic);
    color: var(--primary-dark);
    background: #fefce8;
}

/* Action Buttons */
.action-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: #6b7280;
    font-size: 14px;
}

.action-btn:hover {
    border-color: var(--gold-classic);
    color: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.action-btn.danger:hover {
    border-color: #ef4444;
    color: #ef4444;
    background: #fef2f2;
}

.action-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

/* Drag Handle */
.drag-handle {
    color: #9ca3af;
    cursor: grab;
    font-size: 14px;
    line-height: 1;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    display: none;
}

.drag-handle:hover {
    color: var(--primary-medium);
}

/* View Toggle */
.view-toggle {
    display: flex;
    gap: 5px;
}

.btn.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

/* Responsive */
@media (max-width: 768px) {
    .category-header {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .category-actions {
        width: 100%;
        justify-content: flex-end;
        margin-top: 8px;
    }
    
    .module-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .module-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .subscription-select {
        min-width: 100px;
    }
}

.card h2, .card h3 {
    color: var(--primary-dark);
    margin: 0 0 15px 0;
    padding: 20px 20px 0 20px;
}

.modules-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.module-item {
    background: white;
    border: 2px solid #f1f5f9;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
    cursor: grab;
}

.module-item:hover {
    border-color: var(--gold-classic);
    box-shadow: 0 4px 12px rgba(218, 165, 32, 0.15);
}

.module-item.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.drag-handle {
    color: #9ca3af;
    cursor: grab;
    font-size: 16px;
    line-height: 1;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.drag-handle:hover {
    color: var(--primary-medium);
}

.bulk-checkbox {
    width: 18px;
    height: 18px;
    accent-color: var(--primary-medium);
}

.module-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.module-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.module-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}

.module-icon {
    font-size: 24px;
    width: 40px;
    text-align: center;
}

.module-details {
    flex: 1;
}

.module-title {
    margin: 0 0 5px 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary-dark);
    cursor: pointer;
}

.module-title:hover {
    color: var(--primary-medium);
}

.module-description {
    margin: 0 0 8px 0;
    color: #6b7280;
    font-size: 14px;
    line-height: 1.4;
}

.module-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.category-badge {
    background: #e0f2fe;
    color: #0277bd;
}

.type-badge {
    background: #f3e8ff;
    color: #7c3aed;
}

.duration-badge {
    background: #fef3c7;
    color: #d97706;
}

.module-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.action-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: #6b7280;
}

.action-btn:hover {
    border-color: var(--gold-classic);
    color: var(--primary-dark);
    transform: translateY(-1px);
}

.action-btn.published {
    background: var(--success);
    color: white;
    border-color: var(--success);
}

.action-btn.draft {
    background: #f59e0b;
    color: white;
    border-color: #f59e0b;
}

.action-btn.lead-magnet {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
    border: none;
}

.action-btn.premium {
    background: var(--gold-classic);
    color: white;
    border-color: var(--gold-classic);
}

.module-details-expanded {
    margin-top: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 8px;
    border-left: 4px solid var(--gold-classic);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-item.full-width {
    grid-column: 1 / -1;
}

.detail-item label {
    font-weight: 500;
    color: var(--primary-dark);
    font-size: 14px;
}

.detail-item input, .detail-item select {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.bulk-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.bulk-selection-info {
    font-weight: 500;
    color: var(--primary-medium);
}

.view-toggle {
    display: flex;
    gap: 5px;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    background: var(--primary-medium);
    color: white;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
}

.btn.secondary {
    background: #6b7280;
}

.btn.secondary:hover {
    background: #4b5563;
}

.btn.warning {
    background: #ef4444;
}

.btn.warning:hover {
    background: #dc2626;
}

.form-input, .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary-medium);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    -webkit-backdrop-filter: blur(3px);
    backdrop-filter: blur(3px);
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 85vh;
    overflow-y: auto;
}

.modal-content.large {
    max-width: 800px;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}

.form-grid .full-width {
    grid-column: 1 / -1;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.form-label {
    font-weight: 500;
    color: var(--primary-dark);
}

@media (max-width: 768px) {
    .module-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .module-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .bulk-actions {
        justify-content: center;
    }
}
</style>

<script>
// Global Variables
let bulkModeActive = false;
let sortModeActive = false;
let currentView = 'hierarchy';

// Initialize page
// Add Module Modal Function
function showAddModuleModal() {
    document.getElementById('addModuleModal').style.display = 'block';
}

// Auto-Register Modules Function
function autoRegisterModules() {
    if (!confirm('🚀 Alle neuen HTML-Templates automatisch registrieren?\n\nDies erkennt alle Template-Dateien im templates/ Ordner und registriert sie als Module. Die Module sind zunächst unveröffentlicht und können dann im Admin-Panel angepasst werden.')) {
        return;
    }
    
    showNotification('🔍 Scanne Templates und registriere Module...', 'info');
    
    // Button deaktivieren während der Verarbeitung
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '⏳ Registriere...';
    
    fetch('/admin/auto-register-modules', {
        method: 'GET'
    })
    .then(response => response.text())
    .then(html => {
        // Seite neu laden um Flash-Messages zu zeigen
        window.location.reload();
    })
    .catch(error => {
        showNotification(`❌ Auto-Registrierung fehlgeschlagen: ${error.message}`, 'error');
        btn.disabled = false;
        btn.innerHTML = '🚀 Module auto-registrieren';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    initializeExpandableElements();
});

// Initialize expandable elements
function initializeExpandableElements() {
    // Ensure all category and subcategory contents are properly hidden initially
    const categoryContents = document.querySelectorAll('.category-content');
    categoryContents.forEach(content => {
        if (content.style.display === '') {
            content.style.display = 'none';
        }
    });
    
    // Debug: Log all subcategory elements
    const subcategories = document.querySelectorAll('.category-level-2');
    console.log('Found subcategories:', subcategories.length);
    subcategories.forEach((sub, index) => {
        const id = sub.dataset.subcategoryId;
        const contentElement = document.getElementById(`subcategory-${id}`);
        const iconElement = document.getElementById(`expand-sub-${id}`);
        console.log(`Subcategory ${index + 1}:`, {
            id: id,
            element: sub,
            contentElement: contentElement,
            iconElement: iconElement
        });
    });
    
    console.log('Initialized expandable elements');
}

// Toggle Bulk Selection Mode
function toggleBulkMode() {
    bulkModeActive = !bulkModeActive;
    const checkboxes = document.querySelectorAll('.bulk-checkbox');
    const bulkBtn = document.getElementById('bulkActionsBtn');
    
    checkboxes.forEach(cb => {
        cb.style.display = bulkModeActive ? 'block' : 'none';
    });
    
    if (bulkModeActive) {
        bulkBtn.style.display = 'inline-block';
        document.querySelector('[onclick="toggleBulkMode()"]').textContent = '❌ Bulk-Modus beenden';
    } else {
        bulkBtn.style.display = 'none';
        document.getElementById('bulkActionsPanel').style.display = 'none';
        document.querySelector('[onclick="toggleBulkMode()"]').textContent = '☑️ Bulk-Auswahl';
        // Uncheck all
        checkboxes.forEach(cb => cb.checked = false);
        updateBulkActions();
    }
}

// Toggle Sort Mode
function toggleSortMode() {
    sortModeActive = !sortModeActive;
    const dragHandles = document.querySelectorAll('.drag-handle');
    
    dragHandles.forEach(handle => {
        handle.style.display = sortModeActive ? 'block' : 'none';
    });
    
    const btn = document.querySelector('[onclick="toggleSortMode()"]');
    btn.textContent = sortModeActive ? '✅ Sortieren beenden' : '🔀 Reihenfolge ändern';
    
    if (sortModeActive) {
        enableDragAndDrop();
    } else {
        disableDragAndDrop();
    }
}

// Update Bulk Actions
function updateBulkActions() {
    const selected = document.querySelectorAll('.bulk-checkbox:checked');
    const count = selected.length;
    
    document.getElementById('selectedCount').textContent = count;
    
    if (count > 0 && bulkModeActive) {
        document.getElementById('bulkActionsPanel').style.display = 'block';
    } else {
        document.getElementById('bulkActionsPanel').style.display = 'none';
    }
}

// Show Bulk Actions
function showBulkActions() {
    if (bulkModeActive) {
        document.getElementById('bulkActionsPanel').style.display = 'block';
    }
}

// Bulk Action
function bulkAction(action) {
    const selected = Array.from(document.querySelectorAll('.bulk-checkbox:checked')).map(cb => cb.value);
    
    if (selected.length === 0) {
        alert('Bitte wählen Sie mindestens ein Modul aus.');
        return;
    }
    
    if (action === 'delete' && !confirm(`Sind Sie sicher, dass Sie ${selected.length} Module löschen möchten?`)) {
        return;
    }
    
    fetch('/admin/bulk-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: action,
            type: 'module',
            ids: selected
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Fehler: ' + data.error);
        }
    });
}

// Toggle Module Status
function toggleModuleStatus(moduleId, statusType) {
    fetch(`/admin/toggle-${statusType.replace('_', '-')}/${moduleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        });
}

// Update Sort Order
function updateSortOrder(moduleId, newOrder) {
    fetch('/admin/update-sort-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'module',
            items: [{id: moduleId, order: parseInt(newOrder)}]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Fehler beim Aktualisieren der Sortierung: ' + data.error);
            location.reload();
        }
    });
}

// Update Module Field
function updateModuleField(moduleId, field, value) {
    // This would require a new backend endpoint
    fetch(`/admin/update-module-field`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            module_id: moduleId,
            field: field,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Fehler beim Aktualisieren: ' + data.error);
            location.reload();
        }
    });
}

// Filter Modules
function filterModules() {
    const searchTerm = document.getElementById('searchModules').value.toLowerCase();
    const categoryFilter = document.getElementById('filterCategory').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    const modules = document.querySelectorAll('.module-item');
    
    modules.forEach(module => {
        const title = module.querySelector('.module-title').textContent.toLowerCase();
        const description = module.querySelector('.module-description').textContent.toLowerCase();
        const category = module.dataset.category;
        const status = module.dataset.status;
        const isLeadMagnet = module.dataset.leadMagnet === 'True';
        
        let showModule = true;
        
        // Search filter
        if (searchTerm && !title.includes(searchTerm) && !description.includes(searchTerm)) {
            showModule = false;
        }
        
        // Category filter
        if (categoryFilter && category !== categoryFilter) {
            showModule = false;
        }
        
        // Status filter
        if (statusFilter) {
            if (statusFilter === 'published' && status !== 'published') showModule = false;
            if (statusFilter === 'draft' && status !== 'draft') showModule = false;
            if (statusFilter === 'lead_magnet' && !isLeadMagnet) showModule = false;
        }
        
        module.style.display = showModule ? 'flex' : 'none';
    });
}

// Clear Filters
function clearFilters() {
    document.getElementById('searchModules').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStatus').value = '';
    filterModules();
}

// Switch View (Hierarchy/List)
function switchView(view) {
    currentView = view;
    const hierarchyContainer = document.getElementById('hierarchyContainer');
    const listContainer = document.getElementById('listContainer');
    const hierarchyBtn = document.getElementById('hierarchyViewBtn');
    const listBtn = document.getElementById('listViewBtn');
    
    if (view === 'hierarchy') {
        hierarchyContainer.parentElement.style.display = 'block';
        listContainer.style.display = 'none';
        hierarchyBtn.classList.remove('secondary');
        listBtn.classList.add('secondary');
    } else {
        hierarchyContainer.parentElement.style.display = 'none';
        listContainer.style.display = 'block';
        listBtn.classList.remove('secondary');
        hierarchyBtn.classList.add('secondary');
    }
}

// Edit Module Inline
function editModuleInline(moduleId) {
    const details = document.getElementById(`details-${moduleId}`);
    if (details.style.display === 'none') {
        details.style.display = 'block';
    } else {
        details.style.display = 'none';
    }
}

// Edit Module Access
function editModuleAccess(moduleId) {
    // Simple prompt for now - could be replaced with a modal
    const levels = prompt('Zugriffslevel (comma-separated): basic, premium, elite', '');
    if (levels !== null) {
        updateModuleField(moduleId, 'required_subscription_levels', levels.split(',').map(l => l.trim()));
    }
}

// Show Module Options
function showModuleOptions(moduleId) {
    const options = [
        'Details bearbeiten',
        'Kategorie ändern',
        'Duplizieren',
        'Löschen'
    ];
    
    const choice = prompt('Optionen:\n' + options.map((o, i) => `${i + 1}. ${o}`).join('\n') + '\n\nWählen Sie eine Option (1-4):');
    
    switch(choice) {
        case '1':
            editModuleInline(moduleId);
            break;
        case '2':
            // Category change logic
            break;
        case '3':
            // Duplicate logic
            break;
        case '4':
            if (confirm('Modul wirklich löschen?')) {
                bulkAction('delete');
            }
            break;
    }
}

// === CATEGORY MANAGEMENT FUNCTIONS ===

// Show Add Category Modal
function showAddCategoryModal() {
    document.getElementById('addCategoryModal').style.display = 'block';
}

// Show Add Subcategory Modal
function showAddSubcategoryModal() {
    document.getElementById('addSubcategoryModal').style.display = 'block';
}

// Toggle Category
function toggleCategory(categoryId) {
    const content = document.getElementById(`category-${categoryId}`);
    const icon = document.getElementById(`expand-${categoryId}`);
    
    console.log('Toggling category:', categoryId);
    console.log('Content element:', content);
    console.log('Icon element:', icon);
    
    if (content) {
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            if (icon) icon.classList.add('expanded');
            console.log('Category opened');
        } else {
            content.style.display = 'none';
            if (icon) icon.classList.remove('expanded');
            console.log('Category closed');
        }
    } else {
        console.error('Content element not found for category:', categoryId);
    }
}

// Toggle Subcategory
function toggleSubcategory(subcategoryId) {
    const content = document.getElementById(`subcategory-${subcategoryId}`);
    const icon = document.getElementById(`expand-sub-${subcategoryId}`);
    
    console.log('Toggling subcategory:', subcategoryId);
    console.log('Content element:', content);
    console.log('Icon element:', icon);
    
    if (content) {
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            if (icon) icon.classList.add('expanded');
            console.log('Subcategory opened');
        } else {
            content.style.display = 'none';
            if (icon) icon.classList.remove('expanded');
            console.log('Subcategory closed');
        }
    } else {
        console.error('Content element not found for subcategory:', subcategoryId);
    }
}

// Toggle Unassigned Modules
function toggleUnassigned() {
    const content = document.getElementById('unassigned-modules');
    const icon = document.getElementById('expand-unassigned');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.classList.add('expanded');
    } else {
        content.style.display = 'none';
        icon.classList.remove('expanded');
    }
}

// Edit Category
function editCategory(categoryId) {
    // Fetch category data and populate modal
    fetch(`/admin/get-category/${categoryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_category_id').value = data.category.id;
                document.getElementById('edit_category_name').value = data.category.name;
                document.getElementById('edit_category_icon').value = data.category.icon;
                document.getElementById('edit_category_description').value = data.category.description || '';
                document.getElementById('edit_category_sort_order').value = data.category.sort_order;
                document.getElementById('editCategoryModal').style.display = 'block';
            }
        });
}

// Edit Subcategory
function editSubcategory(subcategoryId) {
    // Fetch subcategory data and populate modal
    fetch(`/admin/get-subcategory/${subcategoryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_subcategory_id').value = data.subcategory.id;
                document.getElementById('edit_subcategory_category_id').value = data.subcategory.category_id;
                document.getElementById('edit_subcategory_name').value = data.subcategory.name;
                document.getElementById('edit_subcategory_icon').value = data.subcategory.icon;
                document.getElementById('edit_subcategory_sort_order').value = data.subcategory.sort_order;
                document.getElementById('editSubcategoryModal').style.display = 'block';
            }
        });
}

// Add Subcategory to specific category
function addSubcategory(categoryId) {
    document.getElementById('addSubcategoryModal').style.display = 'block';
    // Pre-select the category
    const categorySelect = document.querySelector('#addSubcategoryModal select[name="category_id"]');
    categorySelect.value = categoryId;
}

// Toggle Category Status
function toggleCategoryStatus(categoryId) {
    fetch(`/admin/toggle-category-status/${categoryId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Fehler: ' + data.error);
        }
    });
}

// Toggle Subcategory Status
function toggleSubcategoryStatus(subcategoryId) {
    fetch(`/admin/toggle-subcategory-status/${subcategoryId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Fehler: ' + data.error);
        }
    });
}

// Delete Category
function deleteCategory(categoryId) {
    if (confirm('Sind Sie sicher, dass Sie diese Kategorie und alle zugehörigen Unterkategorien löschen möchten?')) {
        fetch(`/admin/delete-category/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        });
    }
}

// Delete Subcategory
function deleteSubcategory(subcategoryId) {
    if (confirm('Sind Sie sicher, dass Sie diese Unterkategorie löschen möchten?')) {
        fetch(`/admin/delete-subcategory/${subcategoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        });
    }
}

// === MODULE MANAGEMENT FUNCTIONS ===

// Change Module Subscription Level
function changeModuleSubscription(moduleId, level) {
    fetch('/admin/change-module-subscription', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            module_id: moduleId,
            subscription_level: level
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update badge visually without reload
            updateModuleBadge(moduleId, level);
        } else {
            alert('Fehler: ' + data.error);
            location.reload();
        }
    });
}

// Update Module Badge
function updateModuleBadge(moduleId, level) {
    const moduleItem = document.querySelector(`[data-module-id="${moduleId}"]`);
    const badge = moduleItem.querySelector('.badge.free, .badge.basic, .badge.premium, .badge.elite');
    
    if (badge) {
        badge.className = 'badge';
        switch(level) {
            case 'free':
                badge.classList.add('free');
                badge.textContent = '🆓 Kostenlos';
                break;
            case 'basic':
                badge.classList.add('basic');
                badge.textContent = '🔓 Basic';
                break;
            case 'premium':
                badge.classList.add('premium');
                badge.textContent = '💰 Premium';
                break;
            case 'elite':
                badge.classList.add('elite');
                badge.textContent = '👑 Elite';
                break;
        }
    }
}

// Move Module (vollständiger Modus mit Modal)
function moveModule(moduleId) {
    document.getElementById('move_module_id').value = moduleId;
    document.getElementById('moveModuleModal').style.display = 'block';
}

// 📦 Quick Move Module - Ein-Klick-Verschieben
function quickMoveModule(moduleId, currentModuleName) {
    // Hole alle Kategorien
    fetch('/admin/get-all-categories')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const categories = data.categories;
                
                // Erstelle Dropdown-Optionen
                let options = categories.map(cat => 
                    `${cat.id}. ${cat.icon} ${cat.name}`
                ).join('\n');
                
                let categoryChoice = prompt(
                    `📦 Modul "${currentModuleName}" verschieben nach:\n\n` +
                    `Wähle Kategorie-Nummer:\n\n` +
                    options +
                    `\n\nGib die Nummer der Ziel-Kategorie ein:`,
                    ''
                );
                
                if (categoryChoice && !isNaN(categoryChoice)) {
                    const categoryId = parseInt(categoryChoice);
                    
                    // Verschiebe Modul
                    fetch(`/admin/move-module/${moduleId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            category_id: categoryId,
                            subcategory_id: null
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('success', `✅ Modul nach "${data.new_category}" verschoben!`);
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            alert('❌ Fehler: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('❌ Fehler beim Verschieben: ' + error);
                    });
                }
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Kategorien:', error);
            // Fallback auf normale moveModule Funktion
            moveModule(moduleId);
        });
}

// Update Subcategory Options when category changes
function updateSubcategoryOptions() {
    const categoryId = document.getElementById('move_category_id').value;
    const subcategorySelect = document.getElementById('move_subcategory_id');
    
    // Clear current options
    subcategorySelect.innerHTML = '<option value="">Keine Unterkategorie (direkt in Hauptkategorie)</option>';
    
    if (categoryId) {
        fetch(`/admin/get-subcategories/${categoryId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.subcategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = `${sub.icon} ${sub.name}`;
                        subcategorySelect.appendChild(option);
                    });
                }
            });
    }
}

// Show Move Module to Subcategory
function showMoveModuleToSubcategory(subcategoryId) {
    // This could open a modal to select which modules to move here
    alert('Funktion zum Verschieben von Modulen in diese Unterkategorie wird implementiert.');
}

// Change Module Sort Order
function changeModuleSortOrder(moduleId, currentOrder) {
    const newOrder = prompt(`Neue Reihenfolge für das Modul eingeben:\n(Aktuelle Reihenfolge: ${currentOrder})`, currentOrder);
    
    if (newOrder !== null && newOrder !== '' && !isNaN(newOrder)) {
        const orderValue = parseInt(newOrder);
        
        fetch('/admin/update-module-sort-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                module_id: moduleId,
                sort_order: orderValue
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', 'Reihenfolge erfolgreich geändert.');
                // Seite neu laden um die neue Sortierung zu zeigen
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Fehler beim Ändern der Reihenfolge: ' + data.error);
            }
        })
        .catch(error => {
            alert('Fehler beim Ändern der Reihenfolge: ' + error);
        });
    }
}

// Delete Module
function deleteModule(moduleId, moduleTitle) {
    if (confirm(`Sind Sie sicher, dass Sie das Modul "${moduleTitle}" PERMANENT löschen möchten?\n\nDiese Aktion kann nicht rückgängig gemacht werden!`)) {
        fetch(`/admin/delete-module/${moduleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Module visuell entfernen
                const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
                if (moduleElement) {
                    moduleElement.style.transition = 'opacity 0.3s ease';
                    moduleElement.style.opacity = '0';
                    setTimeout(() => {
                        moduleElement.remove();
                    }, 300);
                }
                
                // Success-Message anzeigen
                showNotification('success', `Modul "${moduleTitle}" wurde erfolgreich gelöscht.`);
            } else {
                alert('Fehler beim Löschen: ' + data.error);
            }
        })
        .catch(error => {
            alert('Fehler beim Löschen: ' + error);
        });
    }
}

// Show Notification (helper function)
function showNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        transition: all 0.3s ease;
        max-width: 300px;
    `;
    
    if (type === 'success') {
        notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        notification.innerHTML = '✅ ' + message;
    } else if (type === 'error') {
        notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        notification.innerHTML = '❌ ' + message;
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Close Modal
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Export Modules
function exportModules() {
    fetch('/admin/export-structure')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const blob = new Blob([JSON.stringify(data.structure, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'didis-academy-modules.json';
                a.click();
            }
        });
}

// Drag and Drop Functionality
function initializeDragAndDrop() {
    const container = document.getElementById('modulesList');
    let draggedElement = null;
    
    container.addEventListener('dragstart', function(e) {
        if (!sortModeActive) return false;
        
        draggedElement = e.target.closest('.module-item');
        if (draggedElement) {
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
    });
    
    container.addEventListener('dragover', function(e) {
        if (!sortModeActive) return false;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
            container.appendChild(draggedElement);
        } else {
            container.insertBefore(draggedElement, afterElement);
        }
    });
    
    container.addEventListener('dragend', function(e) {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
            updateSortOrderFromDOM();
            draggedElement = null;
        }
    });
}

function enableDragAndDrop() {
    document.querySelectorAll('.module-item').forEach(item => {
        item.draggable = true;
    });
}

function disableDragAndDrop() {
    document.querySelectorAll('.module-item').forEach(item => {
        item.draggable = false;
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.module-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updateSortOrderFromDOM() {
    const modules = document.querySelectorAll('.module-item');
    const updates = [];
    
    modules.forEach((module, index) => {
        const moduleId = module.dataset.moduleId;
        updates.push({ id: parseInt(moduleId), order: index + 1 });
    });
    
    fetch('/admin/update-sort-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'module',
            items: updates
        })
    });
}

// Modal close on outside click
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => modal.style.display = 'none');
    }
});
</script>

{% endblock %}
